<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Zinsrechnung (Dynamisch)</title>
    
    <!-- jsPDF Bibliothek für PDF-Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            /* NEUES FARBSCHEMA (Blau/Grün - Teal) */
            --primary-color: #0d9488; /* Teal-600 */
            --primary-hover: #0f766e; /* Teal-700 */
            --primary-light: #f0fdfa; /* Teal-50 */
            --border-light: #99f6e4; /* Teal-200 */
            --text-highlight: #115e59; /* Teal-800 */
            
            --text-dark: #111827;
            --text-medium: #374151;
            --text-light: #6b7280;
            --border-color: #d1d5db;
            --background-color: #f9fafb; /* Hellerer Hintergrund */
            --card-background: #ffffff;
            --danger-color: #dc2626;
            --success-color: #16a34a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-medium);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Oben ausrichten */
            min-height: 100vh;
        }

        .quiz-container {
            width: 100%;
            max-width: 700px;
        }
        
        /* Basis-Stil für alle "Karten" (Start, Quiz, Ergebnis) */
        .quiz-card {
            background-color: var(--card-background);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            padding: 2.5rem; /* 40px */
            overflow: hidden;
        }

        /* Ansichten (werden per JS ein-/ausgeblendet) */
        .quiz-view {
            display: none; /* Standardmäßig versteckt */
        }
        .quiz-view.active {
            display: block;
        }

        h1, h2 {
            color: var(--text-dark);
            margin-top: 0;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        #start-screen p {
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        /* Formular-Elemente */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box; /* Wichtig für 100% Breite */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: var(--background-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 1.5rem;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 1.25em;
            height: 1.25em;
            margin-right: 0.75rem;
            accent-color: var(--primary-color);
        }
        
        .checkbox-group label {
            margin: 0;
            font-weight: 500;
            color: var(--text-medium);
        }

        /* Buttons */
        button, #certificate {
            display: inline-block;
            width: 100%;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s, opacity 0.2s;
            box-sizing: border-box;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            margin-top: 1.5rem;
        }
        
        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            background-color: #9ca3af; /* Grau */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Quiz-Ansicht */
        #question-counter {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .question-slide {
            display: none; /* Fragen standardmäßig versteckt */
            animation: fadeIn 0.5s ease-in-out;
        }
        .question-slide.active {
            display: block;
        }
        
        .input-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }
        
        .input-container input[type="text"] {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .input-container input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .input-container .unit-label {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-light);
            margin-left: 1rem;
        }
        
        .nav-buttons {
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
        }
        
        .nav-buttons button {
            width: 48%;
        }
        
        .nav-buttons .back-btn {
            background-color: #e5e7eb; /* Hellgrau */
            color: var(--text-medium);
        }
        
        .nav-buttons .back-btn:not(:disabled):hover {
            background-color: #d1d5db; /* Dunkleres Grau */
        }
        
        /* Wichtige Hinweise Box */
        .instructions {
            background-color: var(--primary-light);
            border: 1px solid var(--border-light);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .instructions ul {
            padding-left: 20px;
            margin: 10px 0;
            list-style-type: disc;
        }
        .instructions li {
            margin-bottom: 8px;
            color: var(--text-medium);
        }
        .instructions p {
            margin: 0;
            color: var(--text-medium);
        }
        .instructions .highlight {
            font-weight: 700;
            color: var(--text-highlight);
        }

        /* Ergebnis-Ansicht */
        #resultsContainer h3 {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .result-item {
            padding: 1rem;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 500;
        }
        .result-item.correct {
            background-color: #f0fdf4; /* Hellgrün */
            border-color: #bbf7d0;
            color: #15803d; /* Dunkelgrün */
        }
        .result-item.incorrect {
            background-color: #fef2f2; /* Hellrot */
            border-color: #fecaca;
            color: #b91c1c; /* Dunkelrot */
        }
        .result-item .user-answer {
            font-weight: 400;
            font-style: italic;
            color: var(--text-light);
        }
        
        #certificate {
            background-color: var(--success-color); /* Grün */
            color: white;
            margin-top: 1.5rem;
            display: none; /* Wird per JS angezeigt */
        }
        #certificate:hover {
            background-color: #15803d; /* Dunkleres Grün */
        }

        /* Animation für Slide-Wechsel */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

<div class="quiz-container">

    <!-- ANSICHT 1: START-BILDSCHIRM -->
    <div id="start-screen" class="quiz-view active">
        <!-- .quiz-card umschließt den Inhalt -->
        <div class="quiz-card">
            <h1>Test: Zinsrechnung</h1>
            <p>Bitte gib deine Daten ein, um den Test zu starten.</p>

            <form id="startForm">
                <div class="form-group">
                    <label for="studentName">Dein Name:</label>
                    <input type="text" id="studentName" placeholder="Max Mustermann" required>
                </div>
                <div class="form-group">
                    <label for="studentClass">Deine Klasse:</label>
                    <input type="text" id="studentClass" placeholder="z.B. 10A" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="confirmCheckbox" required>
                    <label for="confirmCheckbox">Ich bestätige, dass ich alle Rechenwege schriftlich festhalte.</label>
                </div>
                <button type="submit" id="startButton" disabled>Test starten</button>
            </form>
        </div>
    </div>

    <!-- ANSICHT 2: QUIZ-BILDSCHIRM -->
    <div id="quiz-screen" class="quiz-view">
        <div class="quiz-card">
            <h2 id="question-counter">Aufgabe 1 von 10</h2>
            
            <div class="instructions">
                <p style="font-weight: 600; color: var(--text-dark);">WICHTIGE HINWEISE:</p>
                <ul>
                    <li>Runde Beträge (Kapital und Zinsen) <span class="highlight">auf 2 Nachkommastellen</span>.</li>
                    <li>Runde Zinssätze <span class="highlight">auf 2 Nachkommastellen</span>.</li>
                    <li>Runde Tage <span class="highlight">auf eine GANZE ZAHL</span>.</li>
                </ul>
                <p>Du kannst ein Komma (,) oder einen Punkt (.) verwenden.</p>
                <p>Gib nur den Zahlenwert ein. Die Einheit (z.B. "€") wird automatisch ergänzt.</p>
            </div>
            
            <!-- Container für die einzelnen Fragen-Slides -->
            <div id="quizContainer" style="margin-top: 25px;">
                <!-- Fragen werden hier dynamisch eingefügt -->
            </div>

            <!-- Navigation für Vor/Zurück/Beenden -->
            <div class="nav-buttons">
                <button type="button" class="back-btn" id="backButton">Zurück</button>
                <button type="button" class="next-btn" id="nextButton">Nächste Frage</button>
            </div>
        </div>
    </div>

    <!-- ANSICHT 3: ERGEBNIS-BILDSCHIRM -->
    <div id="results-screen" class="quiz-view">
        <div class="quiz-card">
            <h2>Auswertung</h2>
            <div id="resultsContainer">
                <!-- Ergebnisse werden hier eingefügt -->
            </div>
            <!-- Zertifikat-Button wird immer angezeigt -->
            <a id="certificate" href="#">
                🎉 Zertifikat herunterladen (PDF)
            </a>
        </div>
    </div>
    
</div> <!-- Ende .quiz-container -->


    <script>
        // Globale Variablen für den Zustand
        let currentQuestionIndex = 0;
        let generatedTasks = [];
        let userAnswers = []; // Array zum Speichern der Benutzereingaben
        let studentName = "";
        let studentClass = "";
        
        // jsPDF initialisieren (wird für PDF benötigt)
        const { jsPDF } = window.jspdf;

        // --- HILFSFUNKTIONEN ---

        /** Rundet eine Zahl auf eine bestimmte Anzahl von Dezimalstellen */
        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

        /** Erzeugt eine zufällige Ganzzahl zwischen min (inklusiv) und max (inklusiv) */
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /** Formatiert eine Zahl als deutsche Währung (z.B. 1.250,00 €) */
        function formatCurrency(value) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
        }
        
        /** Formatiert eine Zahl als deutschen Zinssatz (z.B. 2,50) */
        function formatPercentage(value) {
            return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }
        
        /** Berechnet Zinstage nach der 30/360-Methode */
        function getInterestDays(d1, m1, y1, d2, m2, y2) {
            // Tage anpassen
            if (d1 === 31) d1 = 30;
            if (d2 === 31 && d1 === 30) d2 = 30;
            
            // Monate und Jahre ignorieren wir, da alles im selben Jahr stattfindet
            return (m2 - m1) * 30 + (d2 - d1);
        }
        
        /** Erzeugt ein zufälliges Datum (Tag und Monat) */
        function getRandomDate() {
            const month = getRandomInt(1, 11); // Nur bis November, damit Platz für 2. Datum ist
            const day = getRandomInt(1, 28); // Simpel bis 28, um Monatslängen zu ignorieren
            return { day, month };
        }


        // --- GENERATOR-LOGIK ---

        /** Erstellt 10 zufällige Aufgaben und fügt sie ins HTML ein */
        function generateQuiz() {
            const container = document.getElementById('quizContainer');
            let html = '';
            generatedTasks = []; // Reset
            userAnswers = new Array(10).fill(""); // Reset

            for (let i = 0; i < 10; i++) {
                // 1. "Schöne" Basiswerte generieren
                const K = getRandomInt(10, 800) * 25;  // Kapital (250...20000)
                const p = getRandomInt(5, 70) / 10.0;  // Zinssatz (0.5...7.0)
                const t = getRandomInt(3, 35) * 10;    // Tage (30...350)
                const Z = (K * p * t) / 36000;
                
                // 2. Zufällig entscheiden, wonach gefragt wird (1=Z, 2=K, 3=p, 4=t, 5=Z mit Datum)
                const taskType = getRandomInt(1, 5);
                
                let questionText = '';
                let answer = 0;
                let answerType = ''; // 'currency', 'percentage', 'days'
                let placeholder = 'Zahlenwert';
                let unit = '';

                // Gerundete Werte für die Fragestellung (damit es realistisch aussieht)
                const Z_q = round(Z, 2);
                const K_q = round(K, 2);
                const p_q = round(p, 2);
                
                // Formatierte Werte für die Anzeige
                const K_formatted = formatCurrency(K_q);
                const Z_formatted = formatCurrency(Z_q);
                const p_formatted = formatPercentage(p_q);

                switch (taskType) {
                    case 1: // Frage nach Zinsen
                        questionText = `Berechne die Zinsen für ein Kapital von ${K_formatted} bei ${p_formatted} % p.a. Zinsen für ${t} Tage.`;
                        answer = Z;
                        answerType = 'currency';
                        unit = '€';
                        break;
                    
                    case 2: // Frage nach Kapital
                        questionText = `Welches Kapital bringt ${Z_formatted} Zinsen in ${t} Tagen bei einem Zinssatz von ${p_formatted} % p.a.?`;
                        answer = K;
                        answerType = 'currency';
                        unit = '€';
                        break;
                        
                    case 3: // Frage nach Zinssatz
                        questionText = `Zu welchem Zinssatz wurde ein Kapital von ${K_formatted} angelegt, wenn es in ${t} Tagen ${Z_formatted} Zinsen brachte?`;
                        answer = p;
                        answerType = 'percentage';
                        unit = '% p.a.';
                        break;
                        
                    case 4: // Frage nach Tagen
                        questionText = `Wie viele Tage war ein Kapital von ${K_formatted} zu ${p_formatted} % p.a. angelegt, um ${Z_formatted} Zinsen zu erzielen?`;
                        answer = t;
                        answerType = 'days';
                        unit = 'Tage';
                        break;
                    
                    case 5: // Frage nach Zinsen (mit Datum)
                        const d1 = getRandomDate();
                        const t_calc = getRandomInt(30, 180); // Tage für die 2. Datumsberechnung
                        const d2_total_days = d1.month * 30 + d1.day + t_calc;
                        // Sicherstellen, dass das Enddatum im selben Jahr liegt
                        const m2 = Math.min(12, Math.floor(d2_total_days / 30));
                        const d2 = d2_total_days % 30 === 0 ? 30 : d2_total_days % 30; // 0 wird zu 30
                        
                        // Neuberechnung der Tage, falls m2 > 12 war
                        const final_t_calc = getInterestDays(d1.day, d1.month, 1, d2, m2, 1);

                        const startDateStr = `${d1.day < 10 ? '0' : ''}${d1.day}.${d1.month < 10 ? '0' : ''}${d1.month}.`;
                        const endDateStr = `${d2 < 10 ? '0' : ''}${d2}.${m2 < 10 ? '0' : ''}${m2}.`;

                        const K_calc = getRandomInt(10, 800) * 25;
                        const p_calc = getRandomInt(5, 70) / 10.0;
                        const Z_calc = (K_calc * p_calc * final_t_calc) / 36000;
                        
                        const K_calc_formatted = formatCurrency(K_calc);
                        const p_calc_formatted = formatPercentage(p_calc);

                        questionText = `Welche Zinsen fallen für ein Kapital von ${K_calc_formatted} bei ${p_calc_formatted} % p.a. an, wenn es vom ${startDateStr} bis zum ${endDateStr} (im selben Jahr) angelegt wird?`;
                        answer = Z_calc; 
                        answerType = 'currency'; 
                        unit = '€';
                        break;
                }
                
                // Aufgabe im HTML erstellen
                html += `
                    <div class="question-slide" id="slide-${i}">
                        <label for="q-${i}" style="font-weight: 600; font-size: 1.2rem; color: var(--text-dark);">
                            ${i + 1}. ${questionText}
                        </label>
                        <br>
                        <div class="input-container">
                            <input type="text" id="q-${i}" name="q-${i}" required placeholder="${placeholder}">
                            <span class="unit-label">${unit}</span>
                        </div>
                    </div>
                `;
                
                // Lösung für die spätere Auswertung speichern
                generatedTasks.push({ id: `q-${i}`, question: `${i + 1}. ${questionText}`, answer, answerType });
            }
            
            container.innerHTML = html;
        }

        // --- QUIZ-STEUERUNG ---

        /** Zeigt die Frage mit dem spezifischen Index an */
        function showQuestion(index) {
            // Alle Slides verstecken
            document.querySelectorAll('.question-slide').forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Ziel-Slide anzeigen
            const targetSlide = document.getElementById(`slide-${index}`);
            if (targetSlide) {
                targetSlide.classList.add('active');
                
                // Zuvor gespeicherte Antwort einfügen
                const inputField = targetSlide.querySelector('input');
                if (inputField) {
                    inputField.value = userAnswers[index] || '';
                    // Fokus auf das Eingabefeld setzen
                    setTimeout(() => inputField.focus(), 10); // Kleiner Timeout hilft bei Folienübergang
                }
            }
            
            // Counter aktualisieren
            document.getElementById('question-counter').textContent = `Aufgabe ${index + 1} von ${generatedTasks.length}`;
            
            // Buttons steuern
            document.getElementById('backButton').disabled = (index === 0);
            document.getElementById('nextButton').textContent = (index === generatedTasks.length - 1) ? 'Test beenden' : 'Nächste Frage';
        }

        /** Speichert die aktuelle Antwort */
        function saveCurrentAnswer() {
            const currentInput = document.getElementById(`q-${currentQuestionIndex}`);
            if (currentInput) {
                userAnswers[currentQuestionIndex] = currentInput.value;
            }
        }

        /** Geht zur nächsten Frage */
        function nextQuestion() {
            saveCurrentAnswer();
            if (currentQuestionIndex < generatedTasks.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            } else {
                evaluateQuiz(); // Letzte Frage -> Auswertung
            }
        }

        /** Geht zur vorherigen Frage */
        function prevQuestion() {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }

        /** Startet den Test (Formular-Handler) */
        function startTest(event) {
            event.preventDefault();
            studentName = document.getElementById('studentName').value;
            studentClass = document.getElementById('studentClass').value;
            
            // 1. Quiz generieren
            generateQuiz();
            
            // 2. Erste Frage anzeigen
            showQuestion(0);
            
            // 3. Ansicht wechseln
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            window.scrollTo(0, 0); // Nach oben scrollen
        }
        
        /** Logik für Start-Button (Aktivieren/Deaktivieren) */
        function validateStartForm() {
            const name = document.getElementById('studentName').value;
            const sClass = document.getElementById('studentClass').value;
            const checkbox = document.getElementById('confirmCheckbox').checked;
            document.getElementById('startButton').disabled = !(name && sClass && checkbox);
        }

        /** Wertet das Formular aus */
        function evaluateQuiz() {
            saveCurrentAnswer(); // Letzte Antwort speichern
            
            let correctCount = 0;
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = ''; // Vorherige Ergebnisse löschen
            
            for (let i = 0; i < generatedTasks.length; i++) {
                const task = generatedTasks[i];
                
                // Eingabe normalisieren (Komma zu Punkt)
                const userInputRaw = userAnswers[i] || "";
                const normalizedInput = userInputRaw.replace(',', '.').trim();
                const parsedInput = parseFloat(normalizedInput);

                let formattedInput, formattedExpected;
                let isCorrect = false;
                
                // Eingaben und erwartete Antworten basierend auf dem Typ runden
                switch (task.answerType) {
                    case 'currency': // K oder Z
                        formattedInput = round(parsedInput, 2);
                        formattedExpected = round(task.answer, 2);
                        break;
                    case 'percentage': // p
                        formattedInput = round(parsedInput, 2);
                        formattedExpected = round(task.answer, 2);
                        break;
                    case 'days': // t
                        formattedInput = Math.round(parsedInput);
                        formattedExpected = Math.round(task.answer);
                        break;
                }
                
                isCorrect = (formattedInput === formattedExpected);
                if (isCorrect) correctCount++;
                
                // Ergebnis-Element erstellen
                const resultP = document.createElement('div');
                resultP.classList.add('result-item');
                resultP.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                let resultText = `<strong>${task.question}</strong><br>`;
                if (isCorrect) {
                    resultText += `Richtig! (Deine Antwort: ${formattedInput})`;
                } else {
                    resultText += `Falsch. <span class="user-answer">(Deine Antwort: ${isNaN(parsedInput) ? 'Keine Angabe' : formattedInput})</span><br><strong>Richtige Antwort: ${formattedExpected}</strong>`;
                }
                resultP.innerHTML = resultText;
                resultsContainer.appendChild(resultP);
            }

            // Gesamtergebnis anzeigen
            const totalResultP = document.createElement('h3');
            const percentage = (generatedTasks.length > 0) ? (correctCount / generatedTasks.length) * 100 : 0;
            
            // Neutrale Formulierung, keine Bestehens-Grenze
            totalResultP.textContent = `Dein Ergebnis: ${correctCount} von ${generatedTasks.length} richtig (${percentage.toFixed(0)} %)`;
            
            resultsContainer.prepend(totalResultP);
            
            // Zertifikat-Link wird immer angezeigt
            const certificateLink = document.getElementById('certificate');
            certificateLink.style.display = 'block';

            // Ansicht wechseln
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('results-screen').classList.add('active');
            window.scrollTo(0, 0);
        }
        
        /** Erstellt und lädt das Zertifikat als PDF herunter */
        function downloadCertificate(event) {
            event.preventDefault();
            
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            
            // Farben (Hex-Codes statt CSS-Variablen)
            const colorPrimary = '#0d9488'; // NEUES FARBSCHEMA (Teal-600)
            const colorDark = '#111827';
            const colorMedium = '#374151';
            const colorLight = '#6b7280';
            const colorBorder = '#d1d5db';
            const colorSuccess = '#16a34a';
            const colorDanger = '#dc2626';

            // --- SEITE 1: ZERTIFIKAT ---
            doc.setDrawColor(colorBorder);
            doc.setLineWidth(1.5);
            doc.line(margin, margin, pageWidth - margin, margin); // Obere Linie
            
            doc.setFontSize(32);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(colorPrimary);
            doc.text("ZERTIFIKAT", pageWidth / 2, margin + 25, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(colorMedium);
            doc.text("Zinsrechnung (unterjährig)", pageWidth / 2, margin + 35, { align: 'center' });

            doc.setLineWidth(0.5);
            doc.line(margin, margin + 45, pageWidth - margin, margin + 45); // Untere Linie
            
            // --- Inhaltsbereich ---
            let yPos = margin + 75;
            
            doc.setFontSize(14);
            doc.setTextColor(colorMedium);
            doc.text("Dies bestätigt, dass:", margin, yPos);
            
            yPos += 20;
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(colorDark);
            doc.text(studentName, pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 10;
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(colorLight);
            doc.text(`Klasse: ${studentClass}`, pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 25;
            doc.setFontSize(14);
            doc.setTextColor(colorMedium);
            doc.text("den Test zur Zinsrechnung absolviert hat.", margin, yPos);
            
            yPos += 20;
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(colorDark);
            doc.text("Erreichtes Ergebnis:", margin, yPos);
            
            const correctCount = userAnswers.filter((_, i) => {
                const task = generatedTasks[i];
                const normalizedInput = (userAnswers[i] || "").replace(',', '.').trim();
                const parsedInput = parseFloat(normalizedInput);
                let formattedInput, formattedExpected;
                
                switch (task.answerType) {
                    case 'currency':
                    case 'percentage':
                        formattedInput = round(parsedInput, 2);
                        formattedExpected = round(task.answer, 2);
                        break;
                    case 'days':
                        formattedInput = Math.round(parsedInput);
                        formattedExpected = Math.round(task.answer);
                        break;
                    default:
                        return false;
                }
                return formattedInput === formattedExpected;
            }).length;
            
            const percentage = (generatedTasks.length > 0) ? (correctCount / generatedTasks.length) * 100 : 0;
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(colorMedium);
            doc.text(`${correctCount} von ${generatedTasks.length} Fragen (${percentage.toFixed(0)} %)`, margin + 60, yPos);

            // --- Footer ---
            yPos = pageHeight - margin - 20;
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, pageWidth - margin, yPos); // Linie über Footer
            
            yPos += 10;
            doc.setFontSize(12);
            doc.setTextColor(colorLight);
            const date = new Date().toLocaleDateString('de-DE');
            doc.text(`Ausgestellt am: ${date}`, margin, yPos);
            
            doc.text("Digital generiertes Dokument", pageWidth - margin, yPos, { align: 'right' });
            
            
            // --- SEITE 2: DETAILLIERTE AUSWERTUNG (ANGEPASST FÜR EINE SEITE) ---
            doc.addPage();
            yPos = margin;
            
            // Titel Seite 2
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(colorDark);
            doc.text("Detaillierte Auswertung", pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 12; // Weniger Abstand
            doc.setLineWidth(0.5);
            doc.line(margin, yPos - 5, pageWidth - margin, yPos - 5);
            
            // Loop durch alle Fragen
            for (let i = 0; i < generatedTasks.length; i++) {
                // Die Prüfung auf Seitenumbruch wurde entfernt, da alles auf eine Seite soll.
            
                const task = generatedTasks[i];
                const userInputRaw = userAnswers[i] || "";
                const normalizedInput = userInputRaw.replace(',', '.').trim();
                const parsedInput = parseFloat(normalizedInput);

                let formattedInput, formattedExpected;
                let isCorrect = false;
                let answerSuffix = "";

                switch (task.answerType) {
                    case 'currency':
                        formattedInput = round(parsedInput, 2);
                        formattedExpected = round(task.answer, 2);
                        answerSuffix = " €";
                        break;
                    case 'percentage':
                        formattedInput = round(parsedInput, 2);
                        formattedExpected = round(task.answer, 2);
                        answerSuffix = " % p.a.";
                        break;
                    case 'days':
                        formattedInput = Math.round(parsedInput);
                        formattedExpected = Math.round(task.answer);
                        answerSuffix = " Tage";
                        break;
                }
                
                isCorrect = (formattedInput === formattedExpected);
                // Formatierung für deutsche Zahlen (Komma statt Punkt)
                const displayInput = isNaN(parsedInput) ? 'Keine Angabe' : (new Intl.NumberFormat('de-DE').format(formattedInput)) + answerSuffix;
                const displayExpected = (new Intl.NumberFormat('de-DE').format(formattedExpected)) + answerSuffix;
                
                // Frage (mit Umbruch-Handling)
                doc.setFontSize(10); // Kleinere Schrift
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(colorMedium);
                
                const questionLines = doc.splitTextToSize(task.question, pageWidth - margin * 2);
                doc.text(questionLines, margin, yPos);
                yPos += (questionLines.length * 4.5); // Engerer Zeilenabstand
                
                // Korrekte Antwort
                yPos += 4; // Weniger Abstand
                doc.setFontSize(9); // Kleinere Schrift
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(colorSuccess);
                doc.text(`Korrekte Antwort: ${displayExpected}`, margin, yPos);
                
                // Schüler-Antwort
                yPos += 5; // Weniger Abstand
                if (isCorrect) {
                    doc.setTextColor(colorSuccess); // Grün für richtig
                    doc.text(`Deine Antwort: ${displayInput}`, margin, yPos);
                } else {
                    doc.setTextColor(colorDanger); // Rot für falsch
                    doc.text(`Deine Antwort: ${displayInput}`, margin, yPos);
                }
                
                yPos += 7; // Weniger Abstand
                doc.setDrawColor(colorBorder);
                // Keine Trennlinie, um Platz zu sparen, außer bei der letzten
                if (i < generatedTasks.length - 1) {
                     doc.line(margin, yPos - 3, pageWidth - margin, yPos - 3); // Dünne Trennlinie
                }
            }

            // Speichern
            doc.save(`Zertifikat_Zinsrechnung_${studentName.replace(/ /g, '_')}.pdf`);
        }


        // --- EVENT LISTENERS ---

        // Start-Formular Validierung
        document.getElementById('startForm').addEventListener('input', validateStartForm);
        
        // Start-Button
        document.getElementById('startForm').addEventListener('submit', startTest);
        
        // Quiz-Navigation
        document.getElementById('nextButton').addEventListener('click', nextQuestion);
        document.getElementById('backButton').addEventListener('click', prevQuestion);
        
        // Zertifikat-Download
        document.getElementById('certificate').addEventListener('click', downloadCertificate);

    </script>
</body>
</html>

