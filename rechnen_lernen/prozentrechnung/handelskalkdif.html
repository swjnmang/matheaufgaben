<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handelskalkulation Differenz Variable Gesucht</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content.center;
            align-items: center;
            min-height: 100vh;
            padding: 10px; /* Reduced padding for small screens */
        }
        .container {
            background-color: #ffffff;
            padding: 20px; /* Reduced padding for small screens */
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        #problem-text {
            font-size: 1rem; /* Slightly smaller font for small screens */
            text-align: left;
            margin-bottom: 20px;
            padding: 10px; /* Reduced padding */
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #edf2f7;
        }
        .calculation-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .calculation-table th, .calculation-table td {
            border: 1px solid #cbd5e0;
            padding: 8px; /* Slightly reduced padding */
            text-align: left;
        }
        .calculation-table th {
            background-color: #e2e8f0;
            font-weight: bold;
        }
        .calculation-table td input[type="number"] {
            width: 100px; /* Fixed width for amount input */
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            font-size: 0.9rem; /* Slightly smaller font for inputs */
        }
         .calculation-table td input[type="text"] { /* Added style for text input for percentage */
            width: 60px; /* Fixed width for percentage input */
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            font-size: 0.9rem;
            margin-left: 5px; /* Space between percentage input and % sign */
        }
        .calculation-table td:last-child {
            text-align: right;
            width: 30px; /* Fixed width for feedback icons */
        }
         .calculation-table td:nth-child(2) {
             width: 120px; /* Fixed width for amount column */
         }
        .icon {
            margin-right: 5px;
        }
        .feedback-icon {
            margin-left: 5px;
            font-size: 1rem;
        }
        .correct-feedback {
            color: #10b981; /* Green */
        }
        .incorrect-feedback {
            color: #ef4444; /* Red */
        }
        #solution-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: left;
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word; /* Break long words */
            font-size: 0.9rem; /* Smaller font for solution on small screens */
        }
        .button-group {
            display: flex;
            flex-direction: column; /* Stack buttons on small screens */
            justify-content.center;
            gap: 10px; /* Space between buttons */
            margin-top: 20px;
        }
         .button-group button {
             width: 100%; /* Full width buttons on small screens */
         }
         .hidden {
             display: none;
         }

        /* Responsive Table Styles */
        @media (max-width: 600px) {
            .calculation-table thead {
                display: none; /* Hide table header on small screens */
            }
            .calculation-table, .calculation-table tbody, .calculation-table tr, .calculation-table td {
                display: block; /* Make table elements block level */
                width: 100%;
            }
            .calculation-table tr {
                margin-bottom: 15px;
                border: 1px solid #cbd5e0;
                border-radius: 8px;
                padding: 10px;
                background-color: #ffffff;
            }
            .calculation-table td {
                text-align: right;
                padding-left: 50%; /* Space for the data label */
                position: relative;
            }
            .calculation-table td::before {
                content: attr(data-label); /* Display data-label as a pseudo-element */
                position: absolute;
                left: 10px;
                width: calc(50% - 20px); /* Adjust width */
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
                text-align: left;
            }
             .calculation-table td input[type="number"],
             .calculation-table td input[type="text"] { /* Apply to both input types */
                 width: 100%; /* Make input fill the available space */
                 text-align: right;
             }
             .calculation-table td:last-child {
                 text-align: right;
                 width: auto; /* Auto width for feedback cell */
                 padding-left: 10px; /* Adjust padding */
             }
             .button-group {
                flex-direction: column; /* Ensure buttons are stacked */
             }
             .button-group button {
                 width: 100%; /* Ensure buttons take full width */
             }
        }
    </style>
</head>
<body class="flex items-center justify-center min-height-screen bg-gray-100">
    <div class="container">
        <h1 class="text-2xl font-bold mb-6 text-center">Handelskalkulation Differenzkalkulation Aufgaben</h1>

        <div class="mb-6 text-center">
            <button id="generateBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded rounded-md focus:outline-none focus:shadow-outline">
                <i class="fas fa-sync-alt icon"></i> Neue Aufgabe
            </button>
        </div>

        <div id="problem-text">
            </div>

        <table class="calculation-table">
            <thead>
                <tr>
                    <th>Posten</th>
                    <th>Betrag (€)</th>
                    <th>Feedback</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="Posten">Listeneinkaufspreis netto</td>
                    <td data-label="Betrag (€)"><input type="number" id="listeneinkaufspreis-netto" step="0.01" readonly></td> <td data-label="Feedback" id="feedback-listeneinkaufspreis-netto"></td>
                </tr>
                <tr>
                    <td data-label="Posten">- Liefererrabatt (<span id="liefererrabatt-prozent-span"></span><input type="text" id="liefererrabatt-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="liefererrabatt-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-liefererrabatt-betrag"></td>
                </tr>
                <tr>
                    <td data-label="Posten">= Zieleinkaufspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="zieleinkaufspreis-einkauf" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-zieleinkaufspreis-einkauf"></td>
                </tr>
                <tr>
                    <td data-label="Posten">- Liefererskonto (<span id="liefererskonto-prozent-span"></span><input type="text" id="liefererskonto-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="liefererskonto-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-liefererskonto-betrag"></td>
                </tr>
                <tr>
                    <td data-label="Posten">= Bareinkaufspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="bareinkaufspreis" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-bareinkaufspreis"></td>
                </tr>
                 <tr>
                    <td data-label="Posten">+ Bezugskosten</td>
                    <td data-label="Betrag (€)"><input type="number" id="bezugskosten" step="0.01" readonly></td> <td data-label="Feedback" id="feedback-bezugskosten"></td>
                </tr>
                <tr>
                    <td data-label="Posten">= Bezugspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="bezugspreis" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-bezugspreis"></td>
                </tr>
                <tr>
                    <td data-label="Posten">+ Handlungskostenzuschlag (<span id="handlungskostenzuschlag-prozent-span"></span><input type="text" id="handlungskostenzuschlag-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="handlungskostenzuschlag-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-handlungskostenzuschlag-betrag"></td>
                </tr>
                <tr>
                    <td data-label="Posten">= Selbstkosten</td>
                    <td data-label="Betrag (€)"><input type="number" id="selbstkosten" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-selbstkosten"></td>
                </tr>
                <tr>
                    <td data-label="Posten">+ Gewinn (<span id="gewinn-prozent-span"></span><input type="text" id="gewinn-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="gewinn-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-gewinn-betrag"></td>
                </tr>
                <tr>
                    <td data-label="Posten">= Barverkaufspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="barverkaufspreis-verkauf" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-barverkaufspreis-verkauf"></td>
                </tr>
                 <tr>
                    <td data-label="Posten">+ Kundenskonto (<span id="kundenskonto-prozent-span"></span><input type="text" id="kundenskonto-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="kundenskonto-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-kundenskonto-betrag"></td>
                </tr>
                <tr>
                    <td data-label="Posten">= Zielverkaufspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="zielverkaufspreis" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-zielverkaufspreis"></td>
                </tr>
                 <tr>
                    <td data-label="Posten">+ Kundenrabatt (<span id="kundenrabatt-prozent-span"></span><input type="text" id="kundenrabatt-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="kundenrabatt-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-kundenrabatt-betrag"></td>
                </tr>
                 <tr>
                    <td data-label="Posten">= Nettoverkaufspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="nettoverkaufspreis" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-nettoverkaufspreis"></td>
                </tr>
                 <tr>
                    <td data-label="Posten">+ Umsatzsteuer (<span id="umsatzsteuer-prozent-span"></span><input type="text" id="umsatzsteuer-prozent-input" class="hidden" step="0.1">%)</td>
                    <td data-label="Betrag (€)"><input type="number" id="umsatzsteuer-betrag" step="0.01"></td>
                    <td data-label="Feedback" id="feedback-umsatzsteuer-betrag"></td>
                </tr>
                 <tr>
                    <td data-label="Posten">= Bruttoverkaufspreis</td>
                    <td data-label="Betrag (€)"><input type="number" id="bruttoverkaufspreis" step="0.01" readonly></td> <td data-label="Feedback" id="feedback-bruttoverkaufspreis"></td>
                </tr>
            </tbody>
        </table>

        <div class="button-group">
             <button id="checkBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded rounded-md focus:outline-none focus:shadow-outline">
                 <i class="fas fa-check icon"></i> Überprüfen
            </button>
             <button id="showSolutionBtn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded rounded-md focus:outline-none focus:shadow-outline">
                <i class="fas fa-info-circle icon"></i> Musterlösung anzeigen
            </button>
        </div>


        <div id="overall-feedback" class="mt-6 text-center text-xl font-semibold">
            </div>

        <div id="solution-area" class="hidden">
            </div>

        <div id="progressDisplay" class="mt-4 text-center text-gray-700">
            Richtig gelöst: 0 von 0 Aufgaben
        </div>
    </div>

    <script>
        console.log("Script started");

        const generateBtn = document.getElementById('generateBtn');
        const problemTextDiv = document.getElementById('problem-text');

        // Spans for percentages (will be hidden for the missing step)
        const liefererrabattProzentSpan = document.getElementById('liefererrabatt-prozent-span');
        const liefererskontoProzentSpan = document.getElementById('liefererskonto-prozent-span');
        const handlungskostenzuschlagProzentSpan = document.getElementById('handlungskostenzuschlag-prozent-span');
        const gewinnProzentSpan = document.getElementById('gewinn-prozent-span');
        const kundenskontoProzentSpan = document.getElementById('kundenskonto-prozent-span');
        const kundenrabattProzentSpan = document.getElementById('kundenrabatt-prozent-span');
        const umsatzsteuerProzentSpan = document.getElementById('umsatzsteuer-prozent-span');

        // Input fields for percentages (will be shown for the missing step)
        const liefererrabattProzentInput = document.getElementById('liefererrabatt-prozent-input');
        const liefererskontoProzentInput = document.getElementById('liefererskonto-prozent-input');
        const handlungskostenzuschlagProzentInput = document.getElementById('handlungskostenzuschlag-prozent-input');
        const gewinnProzentInput = document.getElementById('gewinn-prozent-input');
        const kundenskontoProzentInput = document.getElementById('kundenskonto-prozent-input');
        const kundenrabattProzentInput = document.getElementById('kundenrabatt-prozent-input');
        const umsatzsteuerProzentInput = document.getElementById('umsatzsteuer-prozent-input');


        // Input fields (in forward order of table)
        const listeneinkaufspreisNettoInput = document.getElementById('listeneinkaufspreis-netto');
        const liefererrabattBetragInput = document.getElementById('liefererrabatt-betrag');
        const zieleinkaufspreisEinkaufInput = document.getElementById('zieleinkaufspreis-einkauf');
        const liefererskontoBetragInput = document.getElementById('liefererskonto-betrag');
        const bareinkaufspreisInput = document.getElementById('bareinkaufspreis');
        const bezugskostenInput = document.getElementById('bezugskosten');
        const bezugspreisInput = document.getElementById('bezugspreis');
        const handlungskostenzuschlagBetragInput = document.getElementById('handlungskostenzuschlag-betrag');
        const selbstkostenInput = document.getElementById('selbstkosten');
        const gewinnBetragInput = document.getElementById('gewinn-betrag');
        const barverkaufspreisVerkaufInput = document.getElementById('barverkaufspreis-verkauf');
        const kundenskontoBetragInput = document.getElementById('kundenskonto-betrag');
        const zielverkaufspreisInput = document.getElementById('zielverkaufspreis');
        const kundenrabattBetragInput = document.getElementById('kundenrabatt-betrag');
        const nettoverkaufspreisInput = document.getElementById('nettoverkaufspreis');
        const umsatzsteuerBetragInput = document.getElementById('umsatzsteuer-betrag');
        const bruttoverkaufspreisInput = document.getElementById('bruttoverkaufspreis');


        // Feedback elements (in forward order of table)
        const feedbackListeneinkaufspreisNetto = document.getElementById('feedback-listeneinkaufspreis-netto');
        const feedbackLiefererrabattBetrag = document.getElementById('feedback-liefererrabatt-betrag');
        const feedbackZieleinkaufspreisEinkauf = document.getElementById('feedback-zieleinkaufspreis-einkauf');
        const feedbackLiefererskontoBetrag = document.getElementById('feedback-liefererskonto-betrag');
        const feedbackBareinkaufspreis = document.getElementById('feedback-bareinkaufspreis');
        const feedbackBezugskosten = document.getElementById('feedback-bezugskosten');
        const feedbackBezugspreis = document.getElementById('feedback-bezugspreis');
        const feedbackHandlungskostenzuschlagBetrag = document.getElementById('feedback-handlungskostenzuschlag-betrag');
        const feedbackSelbstkosten = document.getElementById('feedback-selbstkosten');
        const feedbackGewinnBetrag = document.getElementById('feedback-gewinn-betrag');
        const feedbackBarverkaufspreisVerkauf = document.getElementById('feedback-barverkaufspreis-verkauf');
        const feedbackKundenskontoBetrag = document.getElementById('feedback-kundenskonto-betrag');
        const feedbackZielverkaufspreis = document.getElementById('feedback-zielverkaufspreis');
        const feedbackKundenrabattBetrag = document.getElementById('feedback-kundenrabatt-betrag');
        const feedbackNettoverkaufspreis = document.getElementById('feedback-nettoverkaufspreis');
        const feedbackUmsatzsteuerBetrag = document.getElementById('feedback-umsatzsteuer-betrag');
        const feedbackBruttoverkaufspreis = document.getElementById('feedback-bruttoverkaufspreis');


        const checkBtn = document.getElementById('checkBtn');
        const showSolutionBtn = document.getElementById('showSolutionBtn');
        const overallFeedbackDiv = document.getElementById('overall-feedback');
        const solutionAreaDiv = document.getElementById('solution-area');
        const progressDisplay = document.getElementById('progressDisplay');

        let correctValues = {};
        let correctAnswers = 0;
        let totalProblems = 0;
        let missingStepKey = ''; // To store the key of the missing step (e.g., 'gewinn')

        // Mapping of missing step key to the corresponding input elements and percentage span/input
        const missingStepElements = {
            'liefererrabatt': { amountInput: liefererrabattBetragInput, percentSpan: liefererrabattProzentSpan, percentInput: liefererrabattProzentInput },
            'liefererskonto': { amountInput: liefererskontoBetragInput, percentSpan: liefererskontoProzentSpan, percentInput: liefererskontoProzentInput },
            'handlungskostenzuschlag': { amountInput: handlungskostenzuschlagBetragInput, percentSpan: handlungskostenzuschlagProzentSpan, percentInput: handlungskostenzuschlagProzentInput },
            'gewinn': { amountInput: gewinnBetragInput, percentSpan: gewinnProzentSpan, percentInput: gewinnProzentInput },
            'kundenskonto': { amountInput: kundenskontoBetragInput, percentSpan: kundenskontoProzentSpan, percentInput: kundenskontoProzentInput },
            'kundenrabatt': { amountInput: kundenrabattBetragInput, percentSpan: kundenrabattProzentSpan, percentInput: kundenrabattProzentInput },
            'umsatzsteuer': { amountInput: umsatzsteuerBetragInput, percentSpan: umsatzsteuerProzentSpan, percentInput: umsatzsteuerProzentInput }
        };

        // Mapping of missing step key to the German label for problem text
        const missingStepLabels = {
             'liefererrabatt': 'Liefererrabatt',
             'liefererskonto': 'Liefererskonto',
             'handlungskostenzuschlag': 'Handlungskostenzuschlag',
             'gewinn': 'Gewinn',
             'kundenskonto': 'Kundenskonto',
             'kundenrabatt': 'Kundenrabatt',
             'umsatzsteuer': 'Umsatzsteuer'
        };

         // Mapping of input element ID to its corresponding correct value key in correctValues
         const inputToCorrectValueKey = {
             'liefererrabatt-betrag': 'liefererrabattBetrag',
             'zieleinkaufspreis-einkauf': 'zieleinkaufspreisEinkauf',
             'liefererskonto-betrag': 'liefererskontoBetrag',
             'bareinkaufspreis': 'bareinkaufspreis',
             'bezugspreis': 'bezugspreis',
             'handlungskostenzuschlag-betrag': 'handlungskostenzuschlagBetrag',
             'selbstkosten': 'selbstkosten',
             'gewinn-betrag': 'gewinnBetrag',
             'barverkaufspreis-verkauf': 'barverkaufspreisVerkauf',
             'kundenskonto-betrag': 'kundenskontoBetrag',
             'zielverkaufspreis': 'zielverkaufspreis',
             'kundenrabatt-betrag': 'kundenrabattBetrag',
             'nettoverkaufspreis': 'nettoverkaufspreis',
             'umsatzsteuer-betrag': 'umsatzsteuerBetrag',
             'liefererrabatt-prozent-input': 'liefererrabattProzent',
             'liefererskonto-prozent-input': 'liefererskontoProzent',
             'handlungskostenzuschlag-prozent-input': 'handlungskostenzuschlagProzent',
             'gewinn-prozent-input': 'gewinnProzent',
             'kundenskonto-prozent-input': 'kundenskontoProzent',
             'kundenrabatt-prozent-input': 'kundenrabattProzent',
             'umsatzsteuer-prozent-input': 'umsatzsteuerProzent'
         };


        // Function to update progress display
        function updateProgress() {
            progressDisplay.textContent = `Richtig gelöst: ${correctAnswers} von ${totalProblems} Aufgaben`;
        }

        // Function to round to 2 decimal places
        function roundToTwoDecimals(num) {
            return parseFloat(num.toFixed(2));
        }

        // Function to round to .0 or .5 decimal places for percentages
        function roundToPointFive(num) {
             return Math.round(num * 2) / 2;
        }

        // Function to generate a Difference Calculation Problem
        function generateProblem() {
             console.log("generateProblem called");

            // Generate random values for percentages and Bezugskosten
            const liefererrabattProzent = roundToPointFive(Math.random() * 15 + 5); // Liefererrabatt zwischen 5% und 20%
            const liefererskontoProzent = roundToPointFive(Math.random() * 2 + 1); // Liefererskonto zwischen 1% und 3%
            const bezugskosten = roundToTwoDecimals(Math.random() * 40 + 10); // Bezugskosten zwischen 10 und 50
            const handlungskostenzuschlagProzent = roundToPointFive(Math.random() * 20 + 10); // Handlungskosten zwischen 10% und 30%
            const gewinnProzent = roundToPointFive(Math.random() * 15 + 5); // Gewinn zwischen 5% und 20%
            const kundenskontoProzent = roundToPointFive(Math.random() * 2 + 1); // Kundenskonto zwischen 1% und 3%
            const kundenrabattProzent = roundToPointFive(Math.random() * 10 + 2); // Kundenrabatt zwischen 2% und 12%
            const umsatzsteuerProzent = 19; // Assuming 19% Umsatzsteuer

            // Generate a random Listeneinkaufspreis netto
            const listeneinkaufspreisNetto = roundToTwoDecimals(Math.random() * 400 + 100); // Start with a random Listeneinkaufspreis netto


            // Calculate all values (forward calculation)
            const liefererrabattBetrag = roundToTwoDecimals(listeneinkaufspreisNetto * (liefererrabattProzent / 100));
            const zieleinkaufspreisEinkauf = roundToTwoDecimals(listeneinkaufspreisNetto - liefererrabattBetrag);

            const liefererskontoBetrag = roundToTwoDecimals(zieleinkaufspreisEinkauf * (liefererskontoProzent / 100));
            const bareinkaufspreis = roundToTwoDecimals(zieleinkaufspreisEinkauf - liefererskontoBetrag);

            const bezugspreis = roundToTwoDecimals(bareinkaufspreis + bezugskosten);

            const handlungskostenzuschlagBetrag = roundToTwoDecimals(bezugspreis * (handlungskostenzuschlagProzent / 100));
            const selbstkosten = roundToTwoDecimals(bezugspreis + handlungskostenzuschlagBetrag);

            const gewinnBetrag = roundToTwoDecimals(selbstkosten * (gewinnProzent / 100));
            const barverkaufspreisVerkauf = roundToTwoDecimals(selbstkosten + gewinnBetrag);

            const kundenskontoBetrag = roundToTwoDecimals(barverkaufspreisVerkauf / (100 - kundenskontoProzent) * kundenskontoProzent);
            const zielverkaufspreis = roundToTwoDecimals(barverkaufspreisVerkauf + kundenskontoBetrag);

            const kundenrabattBetrag = roundToTwoDecimals(zielverkaufspreis / (100 - kundenrabattProzent) * kundenrabattProzent);
            const nettoverkaufspreis = roundToTwoDecimals(zielverkaufspreis + kundenrabattBetrag);

            const umsatzsteuerBetrag = roundToTwoDecimals(nettoverkaufspreis * (umsatzsteuerProzent / 100));
            const bruttoverkaufspreis = roundToTwoDecimals(nettoverkaufspreis + umsatzsteuerBetrag);


            // Store all calculated correct values
            correctValues = {
                listeneinkaufspreisNetto: listeneinkaufspreisNetto,
                liefererrabattProzent: liefererrabattProzent,
                liefererrabattBetrag: liefererrabattBetrag,
                zieleinkaufspreisEinkauf: zieleinkaufspreisEinkauf,
                liefererskontoProzent: liefererskontoProzent,
                liefererskontoBetrag: liefererskontoBetrag,
                bareinkaufspreis: bareinkaufspreis,
                bezugskosten: bezugskosten,
                bezugspreis: bezugspreis,
                handlungskostenzuschlagProzent: handlungskostenzuschlagProzent,
                handlungskostenzuschlagBetrag: handlungskostenzuschlagBetrag,
                selbstkosten: selbstkosten,
                gewinnProzent: gewinnProzent,
                gewinnBetrag: gewinnBetrag,
                barverkaufspreisVerkauf: barverkaufspreisVerkauf,
                kundenskontoProzent: kundenskontoProzent,
                kundenskontoBetrag: kundenskontoBetrag,
                zielverkaufspreis: zielverkaufspreis,
                kundenrabattProzent: kundenrabattProzent,
                kundenrabattBetrag: kundenrabattBetrag,
                nettoverkaufspreis: nettoverkaufspreis,
                umsatzsteuerProzent: umsatzsteuerProzent,
                umsatzsteuerBetrag: umsatzsteuerBetrag,
                bruttoverkaufspreis: bruttoverkaufspreis
            };

             // Select a random intermediate step to be the unknown (excluding first/last and those without percentage)
            const possibleMissingStepKeys = [
                'liefererrabatt', 'liefererskonto',
                'handlungskostenzuschlag', 'gewinn',
                'kundenskonto', 'kundenrabatt', 'umsatzsteuer'
            ];
            missingStepKey = possibleMissingStepKeys[Math.floor(Math.random() * possibleMissingStepKeys.length)];

            console.log("Missing step key:", missingStepKey);

            // Define problem text
            let problemText = `Erstellen Sie die vollständige Handelskalkulation. Der Listeneinkaufspreis netto (${listeneinkaufspreisNetto.toFixed(2)}€) und der Bruttoverkaufspreis (${bruttoverkaufspreis.toFixed(2)}€) sind bekannt.
            <br>Berechnen Sie alle fehlenden Werte, insbesondere den **${missingStepLabels[missingStepKey]}** (€ und %).
            <br>Weitere Angaben: `;

            // Add all given percentages and Bezugskosten to the problem text
            const givenValuesText = [];
            if (missingStepKey !== 'liefererrabatt') givenValuesText.push(`Liefererrabatt: ${liefererrabattProzent.toFixed(1)}%`);
            if (missingStepKey !== 'liefererskonto') givenValuesText.push(`Liefererskonto: ${liefererskontoProzent.toFixed(1)}%`);
            givenValuesText.push(`Bezugskosten: ${bezugskosten.toFixed(2)}€`); // Bezugskosten is always given
            if (missingStepKey !== 'handlungskostenzuschlag') givenValuesText.push(`Handlungskostenzuschlag: ${handlungskostenzuschlagProzent.toFixed(1)}%`);
            if (missingStepKey !== 'gewinn') givenValuesText.push(`Gewinn: ${gewinnProzent.toFixed(1)}%`);
            if (missingStepKey !== 'kundenskonto') givenValuesText.push(`Kundenskonto: ${kundenskontoProzent.toFixed(1)}%`);
            if (missingStepKey !== 'kundenrabatt') givenValuesText.push(`Kundenrabatt: ${kundenrabattProzent.toFixed(1)}%`);
            if (missingStepKey !== 'umsatzsteuer') givenValuesText.push(`Umsatzsteuer: ${umsatzsteuerProzent.toFixed(0)}%`);

            problemText += givenValuesText.join(', ') + '.';


            // Display problem text
            problemTextDiv.innerHTML = problemText;

            // Set percentage spans and inputs
            const percentageElements = [
                { key: 'liefererrabatt', span: liefererrabattProzentSpan, input: liefererrabattProzentInput, value: liefererrabattProzent },
                { key: 'liefererskonto', span: liefererskontoProzentSpan, input: liefererskontoProzentInput, value: liefererskontoProzent },
                { key: 'handlungskostenzuschlag', span: handlungskostenzuschlagProzentSpan, input: handlungskostenzuschlagProzentInput, value: handlungskostenzuschlagProzent },
                { key: 'gewinn', span: gewinnProzentSpan, input: gewinnProzentInput, value: gewinnProzent },
                { key: 'kundenskonto', span: kundenskontoProzentSpan, input: kundenskontoProzentInput, value: kundenskontoProzent },
                { key: 'kundenrabatt', span: kundenrabattProzentSpan, input: kundenrabattProzentInput, value: kundenrabattProzent },
                { key: 'umsatzsteuer', span: umsatzsteuerProzentSpan, input: umsatzsteuerProzentInput, value: umsatzsteuerProzent }
            ];

            percentageElements.forEach(element => {
                 if (element.span && element.input) {
                     if (element.key === missingStepKey) {
                         element.span.classList.add('hidden');
                         element.input.classList.remove('hidden');
                         element.input.value = ''; // Clear input for student
                         element.input.readOnly = false;
                     } else {
                         element.span.classList.remove('hidden');
                         element.input.classList.add('hidden');
                         element.span.textContent = element.value.toFixed(element.key === 'umsatzsteuer' ? 0 : 1);
                         element.input.readOnly = true;
                     }
                 }
            });


            // Set input fields: Listeneinkaufspreis netto, Bruttoverkaufspreis, and Bezugskosten are readonly
            const allInputs = [
                listeneinkaufspreisNettoInput, liefererrabattBetragInput, zieleinkaufspreisEinkaufInput,
                liefererskontoBetragInput, bareinkaufspreisInput, bezugskostenInput,
                bezugspreisInput, handlungskostenzuschlagBetragInput, selbstkostenInput,
                gewinnBetragInput, barverkaufspreisVerkaufInput, kundenskontoBetragInput,
                zielverkaufspreisInput, kundenrabattBetragInput, nettoverkaufspreisInput,
                umsatzsteuerBetragInput, bruttoverkaufspreisInput
            ];

            // Clear all inputs and make them editable by default
            allInputs.forEach(input => {
                input.value = '';
                input.readOnly = false;
            });

            // Set known values and make them readonly
            listeneinkaufspreisNettoInput.value = correctValues.listeneinkaufspreisNetto.toFixed(2);
            listeneinkaufspreisNettoInput.readOnly = true;

            bruttoverkaufspreisInput.value = correctValues.bruttoverkaufspreis.toFixed(2);
            bruttoverkaufspreisInput.readOnly = true;

            // Bezugskosten are also given and readonly
            bezugskostenInput.value = correctValues.bezugskosten.toFixed(2);
            bezugskostenInput.readOnly = true;

            // All intermediate amount inputs are editable


            // Clear feedback elements
            const allFeedbackElements = [
                feedbackListeneinkaufspreisNetto, feedbackLiefererrabattBetrag, feedbackZieleinkaufspreisEinkauf,
                feedbackLiefererskontoBetrag, feedbackBareinkaufspreis, feedbackBezugskosten,
                feedbackBezugspreis, feedbackHandlungskostenzuschlagBetrag, feedbackSelbstkosten,
                feedbackGewinnBetrag, feedbackBarverkaufspreisVerkauf, feedbackKundenskontoBetrag,
                feedbackZielverkaufspreis, feedbackKundenrabattBetrag, feedbackNettoverkaufspreis,
                feedbackUmsatzsteuerBetrag, feedbackBruttoverkaufspreis
            ];
            allFeedbackElements.forEach(feedbackElement => {
                feedbackElement.textContent = '';
            });


            overallFeedbackDiv.textContent = '';
            overallFeedbackDiv.className = 'mt-6 text-center text-xl font-semibold';

            // Hide the solution area when a new problem is generated
            solutionAreaDiv.classList.add('hidden');
             console.log("generateProblem finished");
        }

        // Function to check the answer
        function checkAnswer() {
            console.log("checkAnswer called");

            totalProblems++;

            let allCorrect = true;
            const tolerance = 0.01; // Tolerance for rounding errors
            const percentTolerance = 0.1; // Tolerance for percentage rounding (for .0 or .5 rounding)


            // Check all input fields EXCEPT the readonly ones
            const editableInputs = [
                 liefererrabattBetragInput, zieleinkaufspreisEinkaufInput,
                 liefererskontoBetragInput, bareinkaufspreisInput,
                 bezugspreisInput, handlungskostenzuschlagBetragInput, selbstkostenInput,
                 gewinnBetragInput, barverkaufspreisVerkaufInput, kundenskontoBetragInput,
                 zielverkaufspreisInput, kundenrabattBetragInput, nettoverkaufspreisInput,
                 umsatzsteuerBetragInput,
                 // Include percentage inputs if they are visible
                 liefererrabattProzentInput, liefererskontoProzentInput, handlungskostenzuschlagProzentInput,
                 gewinnProzentInput, kundenskontoProzentInput, kundenrabattProzentInput, umsatzsteuerProzentInput
            ];

            editableInputs.forEach(inputElement => {
                 if (!inputElement.readOnly) { // Only check if the input is editable
                    const isPercentageInput = inputElement.id.includes('-prozent-input');
                    const correctValueKey = inputToCorrectValueKey[inputElement.id];

                    let studentValue = parseFloat(inputElement.value);
                    let correctValue = correctValues[correctValueKey];
                    let feedbackElement = null;

                    // Determine the feedback element for this input
                    if (isPercentageInput) {
                        const amountInputId = inputElement.id.replace('-prozent-input', '-betrag');
                        feedbackElement = document.getElementById(`feedback-${amountInputId}`);
                    } else {
                         feedbackElement = document.getElementById(`feedback-${inputElement.id}`);
                    }


                    if (feedbackElement) { // Ensure feedback element exists
                        // We will handle feedback for both amount and percentage in the amount's feedback cell for simplicity
                        // A more complex UI could have separate feedback for percentage.
                        // For now, we'll just mark the row as incorrect if either is wrong.
                        if (isNaN(studentValue)) {
                            allCorrect = false;
                        } else {
                             const currentTolerance = isPercentageInput ? percentTolerance : tolerance;
                            if (Math.abs(studentValue - correctValue) >= currentTolerance) {
                                allCorrect = false;
                            }
                        }
                    }
                 }
            });

             // Update feedback icons based on the overall correctness check
             const allFeedbackElements = [
                 feedbackLiefererrabattBetrag, feedbackZieleinkaufspreisEinkauf,
                 feedbackLiefererskontoBetrag, feedbackBareinkaufspreis,
                 feedbackBezugspreis, feedbackHandlungskostenzuschlagBetrag, feedbackSelbstkosten,
                 feedbackGewinnBetrag, feedbackBarverkaufspreisVerkauf, feedbackKundenskontoBetrag,
                 feedbackZielverkaufspreis, feedbackKundenrabattBetrag, feedbackNettoverkaufspreis,
                 feedbackUmsatzsteuerBetrag
             ];

             allFeedbackElements.forEach(feedbackElement => {
                 const amountInputId = feedbackElement.id.replace('feedback-', '');
                 const amountInput = document.getElementById(amountInputId);

                 if (amountInput && !amountInput.readOnly) { // Check only editable amount inputs
                     const baseKey = amountInputId.replace('-betrag', '').replace('-einkauf', '').replace('-verkauf', '');
                     const percentInput = document.getElementById(`${baseKey}-prozent-input`);

                     let amountCorrect = true;
                     let percentCorrect = true;

                     // Check amount input
                     const studentAmount = parseFloat(amountInput.value);
                     const correctAmountKey = inputToCorrectValueKey[amountInputId];
                     const correctAmount = correctValues[correctAmountKey];

                     if (isNaN(studentAmount) || Math.abs(studentAmount - correctAmount) >= tolerance) {
                         amountCorrect = false;
                     }

                     // Check percentage input if visible
                     if (percentInput && !percentInput.classList.contains('hidden')) {
                         const studentPercent = parseFloat(percentInput.value);
                         const correctPercentKey = inputToCorrectValueKey[percentInput.id];
                         const correctPercent = correctValues[correctPercentKey];

                         if (isNaN(studentPercent) || Math.abs(studentPercent - correctPercent) >= percentTolerance) {
                             percentCorrect = false;
                         }
                     }

                     feedbackElement.textContent = ''; // Clear previous feedback
                     if (amountCorrect && percentCorrect) {
                         feedbackElement.innerHTML = '<i class="fas fa-check-circle correct-feedback"></i>'; // Green check icon
                     } else {
                         feedbackElement.innerHTML = '<i class="fas fa-times-circle incorrect-feedback"></i>'; // Red X icon
                         allCorrect = false; // Ensure overall correctness reflects any individual error
                     }
                 }
             });


            // Provide overall feedback
            if (allCorrect) {
                overallFeedbackDiv.textContent = 'Sehr gut! Die Handelskalkulation ist korrekt.';
                overallFeedbackDiv.className = 'mt-6 text-center text-xl font-semibold text-green-500';
                correctAnswers++;
            } else {
                overallFeedbackDiv.textContent = 'Leider sind noch nicht alle Werte korrekt. Überprüfe deine Berechnungsschritte.';
                overallFeedbackDiv.className = 'mt-6 text-center text-xl font-semibold text-red-500';
            }

            updateProgress();
             console.log("checkAnswer finished");
        }

        // Function to show the solution
        function showSolution() {
            console.log("showSolution called");

            const solutionText = `
                Musterlösung (Differenzkalkulation):

                Listeneinkaufspreis netto: ${correctValues.listeneinkaufspreisNetto.toFixed(2)} €
                - Liefererrabatt (${correctValues.liefererrabattProzent.toFixed(1)}%): ${correctValues.liefererrabattBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.listeneinkaufspreisNetto.toFixed(2)} € * ${correctValues.liefererrabattProzent.toFixed(1)} / 100)
                = Zieleinkaufspreis: ${correctValues.zieleinkaufspreisEinkauf.toFixed(2)} €
                  (Berechnung: ${correctValues.listeneinkaufspreisNetto.toFixed(2)} € - ${correctValues.liefererrabattBetrag.toFixed(2)} €)
                - Liefererskonto (${correctValues.liefererskontoProzent.toFixed(1)}%): ${correctValues.liefererskontoBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.zieleinkaufspreisEinkauf.toFixed(2)} € * ${correctValues.liefererskontoProzent.toFixed(1)} / 100)
                = Bareinkaufspreis: ${correctValues.bareinkaufspreis.toFixed(2)} €
                  (Berechnung: ${correctValues.zieleinkaufspreisEinkauf.toFixed(2)} € - ${correctValues.liefererskontoBetrag.toFixed(2)} €)
                + Bezugskosten: ${correctValues.bezugskosten.toFixed(2)} €
                = Bezugspreis: ${correctValues.bezugspreis.toFixed(2)} €
                  (Berechnung: ${correctValues.bareinkaufspreis.toFixed(2)} € + ${correctValues.bezugskosten.toFixed(2)} €)
                + Handlungskostenzuschlag (${correctValues.handlungskostenzuschlagProzent.toFixed(1)}%): ${correctValues.handlungskostenzuschlagBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.bezugspreis.toFixed(2)} € * ${correctValues.handlungskostenzuschlagProzent.toFixed(1)} / 100)
                = Selbstkosten: ${correctValues.selbstkosten.toFixed(2)} €
                  (Berechnung: ${correctValues.bezugspreis.toFixed(2)} € + ${correctValues.handlungskostenzuschlagBetrag.toFixed(2)} €)
                + Gewinn (${correctValues.gewinnProzent.toFixed(1)}%): ${correctValues.gewinnBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.selbstkosten.toFixed(2)} € * ${correctValues.gewinnProzent.toFixed(1)} / 100)
                = Barverkaufspreis: ${correctValues.barverkaufspreisVerkauf.toFixed(2)} €
                  (Berechnung: ${correctValues.selbstkosten.toFixed(2)} € + ${correctValues.gewinnBetrag.toFixed(2)} €)
                + Kundenskonto (${correctValues.kundenskontoProzent.toFixed(1)}%): ${correctValues.kundenskontoBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.barverkaufspreisVerkauf.toFixed(2)} € / (100 - ${correctValues.kundenskontoProzent.toFixed(1)}) * ${correctValues.kundenskontoProzent.toFixed(1)})
                = Zielverkaufspreis: ${correctValues.zielverkaufspreis.toFixed(2)} €
                  (Berechnung: ${correctValues.barverkaufspreisVerkauf.toFixed(2)} € + ${correctValues.kundenskontoBetrag.toFixed(2)} €)
                + Kundenrabatt (${correctValues.kundenrabattProzent.toFixed(1)}%): ${correctValues.kundenrabattBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.zielverkaufspreis.toFixed(2)} € / (100 - ${correctValues.kundenrabattProzent.toFixed(1)}) * ${correctValues.kundenrabattProzent.toFixed(1)})
                = Nettoverkaufspreis: ${correctValues.nettoverkaufspreis.toFixed(2)} €
                  (Berechnung: ${correctValues.zielverkaufspreis.toFixed(2)} € + ${correctValues.kundenrabattBetrag.toFixed(2)} €)
                + Umsatzsteuer (${correctValues.umsatzsteuerProzent.toFixed(0)}%): ${correctValues.umsatzsteuerBetrag.toFixed(2)} €
                  (Berechnung: ${correctValues.nettoverkaufspreis.toFixed(2)} € * ${correctValues.umsatzsteuerProzent.toFixed(0)} / 100)
                = Bruttoverkaufspreis: ${correctValues.bruttoverkaufspreis.toFixed(2)} €
                  (Berechnung: ${correctValues.nettoverkaufspreis.toFixed(2)} € + ${correctValues.umsatzsteuerBetrag.toFixed(2)} €)
            `;
            solutionAreaDiv.textContent = solutionText;
            solutionAreaDiv.classList.remove('hidden');
             console.log("showSolution finished");
        }


        // Event Listeners
        generateBtn.addEventListener('click', generateProblem);
        checkBtn.addEventListener('click', checkAnswer);
        showSolutionBtn.addEventListener('click', showSolution);

        // Generate first problem on page load and initialize progress
        generateProblem();
        updateProgress();

        console.log("Script initialization finished");

    </script>
</body>
</html>
