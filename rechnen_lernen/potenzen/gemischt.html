<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potenzterme Zusammenfassen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-card {
            background-color: #f9fafb; /* Tailwind gray-50 */
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.75rem; /* Tailwind rounded-xl */
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Tailwind shadow-lg */
        }
        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500; /* Tailwind medium */
            color: #374151; /* Tailwind gray-700 */
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.375rem; /* Tailwind rounded-md */
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Tailwind shadow-sm */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .input-field:focus {
            border-color: #2563eb; /* Tailwind blue-600 */
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25); /* Tailwind focus:ring-blue-500 */
            outline: none;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem; /* Tailwind rounded-md */
            font-weight: 600; /* Tailwind semibold */
            color: white;
            transition: background-color 0.15s ease-in-out;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* Tailwind blue-700 */
        }
        .btn-secondary {
            background-color: #4b5563; /* Tailwind gray-600 */
        }
        .btn-secondary:hover {
            background-color: #374151; /* Tailwind gray-700 */
        }
        .feedback {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem; /* Tailwind rounded-md */
            font-weight: 500;
        }
        .feedback-correct {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
            border: 1px solid #6ee7b7; /* Tailwind green-300 */
        }
        .feedback-incorrect {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
            border: 1px solid #fca5a5; /* Tailwind red-300 */
        }
        .difficulty-btn-group button {
            margin-right: 0.5rem;
        }
        .difficulty-btn-group button.active {
            background-color: #1d4ed8; /* Tailwind blue-700 */
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }
        /* Stile für mathematische Darstellung */
        .math-term {
            font-family: 'Times New Roman', Times, serif;
            font-size: 1.4em; 
            letter-spacing: 1px;
            line-height: 1.8; 
        }
        .math-term sup {
            font-size: 0.75em;
            vertical-align: super;
            margin-left: 1px;
        }
        #userInputPreview {
            margin-top: 1rem;
            padding: 0.75rem;
            border: 1px dashed #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.375rem;
            min-height: 2.5em; /* Ensure space even when empty */
            text-align: center;
            color: #4b5563; /* Tailwind gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="task-card w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Potenzterme Zusammenfassen</h1>

        <div class="mb-6">
            <label class="input-label text-lg">Schwierigkeitsstufe wählen:</label>
            <div class="difficulty-btn-group flex justify-center">
                <button id="level1" class="btn btn-primary active" onclick="selectLevel(1)">Leicht</button>
                <button id="level2" class="btn btn-primary" onclick="selectLevel(2)">Mittel</button>
                <button id="level3" class="btn btn-primary" onclick="selectLevel(3)">Schwer</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6 min-h-[80px]">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Aufgabe:</h2>
            <p id="task" class="text-xl md:text-2xl text-center font-mono py-4 bg-gray-100 rounded-md math-term">-</p>
        </div>

        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Deine Lösung:</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                <div>
                    <label for="coeffInput" class="input-label">Vorzahl:</label>
                    <input type="number" id="coeffInput" class="input-field" placeholder="z.B. 6">
                </div>
                <div>
                    <label for="baseInput" class="input-label">Basis:</label>
                    <input type="text" id="baseInput" class="input-field" placeholder="z.B. x" maxlength="1">
                </div>
                <div>
                    <label for="expInput" class="input-label">Exponent:</label>
                    <input type="number" id="expInput" class="input-field" placeholder="z.B. 5">
                </div>
            </div>
            <div id="userInputPreview" class="math-term">Vorschau: -</div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
            <button onclick="checkAnswer()" class="btn btn-primary w-full sm:w-auto">Antwort prüfen</button>
            <button onclick="generateNewTask()" class="btn btn-secondary w-full sm:w-auto">Neue Aufgabe</button>
        </div>

        <div id="feedback" class="feedback hidden mt-4"></div>
    </div>

    <script>
        let currentTask = {};
        let currentLevel = 1;
        let usedTasksIndices = { 1: [], 2: [], 3: [] }; 

        const tasksByLevel = {
            1: [ // Leicht: Fokus auf einzelne Grundregeln, Einführung Addition/Subtraktion
                { text: "x<sup>2</sup> * x<sup>3</sup>", solution: { coeff: 1, base: 'x', exp: 5 } },
                { text: "a<sup>5</sup> / a<sup>2</sup>", solution: { coeff: 1, base: 'a', exp: 3 } },
                { text: "(y<sup>3</sup>)<sup>2</sup>", solution: { coeff: 1, base: 'y', exp: 6 } },
                { text: "2b<sup>4</sup> + 3b<sup>4</sup>", solution: { coeff: 5, base: 'b', exp: 4 } },
                { text: "7m<sup>3</sup> - 4m<sup>3</sup>", solution: { coeff: 3, base: 'm', exp: 3 } },
                { text: "(x<sup>2</sup> * x<sup>4</sup>) / x<sup>3</sup>", solution: { coeff: 1, base: 'x', exp: 3 } },
                { text: "c<sup>8</sup> / (c<sup>2</sup> * c<sup>3</sup>)", solution: { coeff: 1, base: 'c', exp: 3 } },
                { text: "5p<sup>2</sup> + p<sup>2</sup> - 2p<sup>2</sup>", solution: { coeff: 4, base: 'p', exp: 2 } }, // p^2 ist 1*p^2
                { text: "(z<sup>1</sup>)<sup>3</sup> * z<sup>2</sup>", solution: { coeff: 1, base: 'z', exp: 5 } },
                { text: "10n<sup>5</sup> / n<sup>2</sup> - 3n<sup>3</sup>", solution: { coeff: 7, base: 'n', exp: 3 } },
                { text: "4x<sup>2</sup> * 2x<sup>0</sup>", solution: { coeff: 8, base: 'x', exp: 2 } }, // x^0 = 1
                { text: "6y<sup>3</sup> + (y<sup>4</sup> / y<sup>1</sup>)", solution: { coeff: 7, base: 'y', exp: 3 } }
            ],
            2: [ // Mittel: Mit Koeffizienten, Kombinationen, erste gemischte Aufgaben
                { text: "2x<sup>3</sup> * 3x<sup>2</sup> + 4x<sup>5</sup>", solution: { coeff: 10, base: 'x', exp: 5 } },
                { text: "10a<sup>5</sup> / (2a<sup>2</sup>) - a<sup>3</sup>", solution: { coeff: 4, base: 'a', exp: 3 } },
                { text: "(3y<sup>2</sup>)<sup>3</sup> - 7y<sup>6</sup>", solution: { coeff: 20, base: 'y', exp: 6 } }, // 27y^6 - 7y^6
                { text: "4b<sup>2</sup> * 2b<sup>3</sup> + b<sup>5</sup> - 3b<sup>5</sup>", solution: { coeff: 6, base: 'b', exp: 5 } }, // 8b^5 + b^5 - 3b^5
                { text: "(12m<sup>6</sup> / (3m<sup>2</sup>)) * 2m<sup>1</sup> - 5m<sup>5</sup>", solution: { coeff: 3, base: 'm', exp: 5 } }, // 4m^4 * 2m^1 - 5m^5 = 8m^5 - 5m^5
                { text: "5x<sup>4</sup> * (2x<sup>1</sup>)<sup>2</sup> + 10x<sup>6</sup>", solution: { coeff: 30, base: 'x', exp: 6 } }, // 5x^4 * 4x^2 + 10x^6 = 20x^6 + 10x^6
                { text: "(15c<sup>7</sup> / 5c<sup>3</sup>) / c<sup>2</sup> + 7c<sup>2</sup>", solution: { coeff: 10, base: 'c', exp: 2 } }, // 3c^4 / c^2 + 7c^2 = 3c^2 + 7c^2
                { text: "2p<sup>2</sup> * (6p<sup>4</sup> / (3p<sup>1</sup>)) - p<sup>5</sup>", solution: { coeff: 3, base: 'p', exp: 5 } }, // 2p^2 * 2p^3 - p^5 = 4p^5 - p^5
                { text: "(2z<sup>3</sup>)<sup>2</sup> / z<sup>2</sup> + 3z<sup>4</sup> - z<sup>4</sup>", solution: { coeff: 6, base: 'z', exp: 4 } }, // 4z^6 / z^2 + 2z^4 = 4z^4 + 2z^4
                { text: "(16n<sup>8</sup> / (2n<sup>3</sup>)) * (n<sup>1</sup> / (4n<sup>0</sup>)) - 2n<sup>6</sup>", solution: { coeff: 0, base: 'n', exp: 6 } }, // (8n^5 * n/4) - 2n^6 = 2n^6 - 2n^6. Spezieller Fall: Koeffizient 0
                { text: "3 * (2x<sup>2</sup> + 4x<sup>2</sup>) - 5x<sup>2</sup>", solution: { coeff: 13, base: 'x', exp: 2 } }, // 3 * 6x^2 - 5x^2 = 18x^2 - 5x^2
                { text: "(4y<sup>3</sup> - y<sup>3</sup>) * (2y<sup>1</sup>)<sup>2</sup>", solution: { coeff: 12, base: 'y', exp: 5 } } // 3y^3 * 4y^2
            ],
            3: [ // Schwer: Komplexere Terme, mehrere Operationen, höhere Potenzen/Koeffizienten, Klammern
                { text: "(2x<sup>2</sup> * 3x<sup>3</sup>)<sup>2</sup> / (6x<sup>4</sup>) + 4x<sup>6</sup>", solution: { coeff: 10, base: 'x', exp: 6 } }, // (6x^5)^2 / 6x^4 + 4x^6 = 36x^10 / 6x^4 + 4x^6 = 6x^6 + 4x^6
                { text: "((4a<sup>3</sup>)<sup>2</sup> / (2a<sup>2</sup>)) * 3a<sup>1</sup> - 10a<sup>5</sup> + a<sup>5</sup>", solution: { coeff: 15, base: 'a', exp: 5 } }, // (16a^6 / 2a^2) * 3a - 9a^5 = 8a^4 * 3a - 9a^5 = 24a^5 - 9a^5
                { text: "( (10y<sup>5</sup> / 5y<sup>2</sup>)<sup>3</sup> * y<sup>1</sup> ) / (2y<sup>4</sup>) - y<sup>6</sup>", solution: { coeff: 3, base: 'y', exp: 6 } }, // ((2y^3)^3 * y) / 2y^4 - y^6 = (8y^9 * y) / 2y^4 - y^6 = 8y^10 / 2y^4 - y^6 = 4y^6 - y^6
                { text: "(3b<sup>2</sup>)<sup>3</sup> / ( (9b<sup>4</sup> / b<sup>1</sup>) * b<sup>0</sup> ) + 2b<sup>3</sup>", solution: { coeff: 5, base: 'b', exp: 3 } }, // 27b^6 / (9b^3 * 1) + 2b^3 = 3b^3 + 2b^3
                { text: "((2m<sup>3</sup> * 5m<sup>1</sup>) / m<sup>2</sup>)<sup>2</sup> * (m<sup>3</sup> / (2m<sup>1</sup>)) - 10m<sup>6</sup>", solution: { coeff: 40, base: 'm', exp: 6 } }, // ((10m^4)/m^2)^2 * (m^2/2) - 10m^6 = (10m^2)^2 * m^2/2 - 10m^6 = 100m^4 * m^2/2 - 10m^6 = 50m^6 - 10m^6
                { text: "20x<sup>10</sup> / (2x<sup>2</sup>)<sup>2</sup> * (3x<sup>1</sup> / x<sup>3</sup>) + 5x<sup>4</sup>", solution: { coeff: 20, base: 'x', exp: 4 } }, // 20x^10 / 4x^4 * 3x^-2 + 5x^4 = 5x^6 * 3x^-2 + 5x^4 = 15x^4 + 5x^4
                { text: "( ( (c<sup>4</sup>)<sup>3</sup> / c<sup>5</sup> ) * 2c<sup>1</sup>)<sup>2</sup> / (4c<sup>6</sup>) - c<sup>10</sup>", solution: { coeff: 0, base: 'c', exp: 10 } }, // ((c^12/c^5)*2c)^2 / 4c^6 - c^10 = (c^7*2c)^2 / 4c^6 - c^10 = (2c^8)^2 / 4c^6 - c^10 = 4c^16 / 4c^6 - c^10 = c^10 - c^10
                { text: "5 * ( (2p<sup>3</sup>)<sup>2</sup> + p<sup>6</sup> ) - ( (10p<sup>4</sup> * 2p<sup>3</sup>) / p<sup>1</sup> )", solution: { coeff: 5, base: 'p', exp: 6 } }, // 5*(4p^6+p^6) - (20p^7/p) = 5*5p^6 - 20p^6 = 25p^6 - 20p^6
                { text: "( (5z<sup>3</sup> * 2z<sup>0</sup>)<sup>2</sup> / (10z<sup>2</sup>) ) + ( (2z<sup>4</sup>) / z<sup>1</sup> )<sup>2</sup> / (2z<sup>2</sup>)", solution: { coeff: 4.5, base: 'z', exp: 4 } }, // ((5z^3*2)^2 / 10z^2) + (2z^3)^2 / 2z^2 = (10z^3)^2 / 10z^2 + 4z^6 / 2z^2 = 100z^6 / 10z^2 + 2z^4 = 10z^4 + 2z^4 = 12z^4. MISTAKE IN MANUAL CALC. Let's re-evaluate this task or simplify.
                                                                                                                                    // ( (5z^3 * 2)^2 / (10z^2) ) + ( (2z^4) / z^1 ) * ( (2z^4) / z^1 ) / (2z^2)
                                                                                                                                    // ( (10z^3)^2 / (10z^2) ) + (2z^3) * (2z^3) / (2z^2)
                                                                                                                                    // ( 100z^6 / (10z^2) ) + 4z^6 / (2z^2)
                                                                                                                                    // 10z^4 + 2z^4 = 12z^4.  Okay, solution should be {coeff: 12, base: 'z', exp: 4}
                { text: "( (5z<sup>3</sup> * 2z<sup>0</sup>)<sup>2</sup> / (10z<sup>2</sup>) ) + ( ( (2z<sup>2</sup>)<sup>2</sup> ) / (2z<sup>0</sup>) )", solution: { coeff: 14, base: 'z', exp: 4 } }, // ( (10z^3)^2 / 10z^2 ) + ( 4z^4 / 2 ) = (100z^6 / 10z^2) + 2z^4 = 10z^4 + 2z^4. No, (4z^4 / (2*1)) = 2z^4. So 10z^4 + 2z^4 = 12z^4.
                                                                                                                                        // Let's simplify the problem: ( (5z^3 * 2) / (10z^2) ) * (5z^3 * 2) + ( (2z^2)^2 / 2)
                                                                                                                                        // ( (10z^3)^2 / (10z^2) ) + (4z^4 / 2) = (100z^6 / 10z^2) + 2z^4 = 10z^4 + 2z^4 = 12z^4.
                                                                                                                                        // New task for variety:
                { text: "3 * (x<sup>2</sup>y<sup>3</sup>)<sup>2</sup> / (x<sup>1</sup>y<sup>2</sup>) + 2x<sup>3</sup>y<sup>4</sup>", solution: { coeff: 5, base: 'x', exp: 3 }, secondary_solution: { base: 'y', exp: 4} }, // This task introduces two bases, current system does not support this. Removing.
                // Re-crafting a complex one that simplifies to one base:
                { text: "((3n<sup>2</sup>)<sup>3</sup> * 2n) / (6n<sup>5</sup>) - (3n<sup>0</sup> * 2n<sup>2</sup>) + 5n<sup>2</sup>", solution: { coeff: 6, base: 'n', exp: 2 } } // (27n^6 * 2n) / 6n^5 - (3*1*2n^2) + 5n^2 = 54n^7 / 6n^5 - 6n^2 + 5n^2 = 9n^2 - 6n^2 + 5n^2
            ]
        };
        // Correcting the complex 'z' task and one 'n' task
        tasksByLevel[3][8] = { text: "( (5z<sup>3</sup> * 2z<sup>0</sup>)<sup>2</sup> / (5z<sup>2</sup>) ) + ( (2z<sup>3</sup>)<sup>2</sup> / z<sup>2</sup> ) - z<sup>4</sup>", solution: { coeff: 23, base: 'z', exp: 4 } };
        // ( (10z^3)^2 / 5z^2 ) + (4z^6 / z^2) - z^4 = (100z^6 / 5z^2) + 4z^4 - z^4 = 20z^4 + 4z^4 - z^4 = 23z^4

        tasksByLevel[3][9] = { text: "(((3n<sup>2</sup>)<sup>3</sup> * 2n) / (3n<sup>4</sup>)) / (2n<sup>1</sup>) - (n<sup>0</sup> * 5n<sup>2</sup>)", solution: { coeff: 4, base: 'n', exp: 2 } };
        // ( (27n^6 * 2n) / 3n^4 ) / 2n - 5n^2 = (54n^7 / 3n^4) / 2n - 5n^2 = (18n^3) / 2n - 5n^2 = 9n^2 - 5n^2 = 4n^2


        function formatTermPreview(coeff, base, exp) {
            if (base === "" && isNaN(coeff) && isNaN(exp)) return "Vorschau: -";
            
            let cStr = isNaN(coeff) || coeff === "" ? "" : coeff.toString();
            let bStr = base === "" ? "" : base;
            let eStr = isNaN(exp) || exp === "" ? "" : exp.toString();

            if (bStr === "" && eStr !== "" && eStr !== "0" && cStr !== "") return `Vorschau: ${cStr} * ?<sup>${eStr}</sup>`; 
            if (bStr === "" && eStr !== "" && eStr !== "0" && cStr === "") return `Vorschau: ?<sup>${eStr}</sup>`;
            if (bStr !== "" && eStr === "" && cStr !== "") return `Vorschau: ${cStr} * ${bStr}<sup>?</sup>`;
            if (bStr !== "" && eStr === "" && cStr === "") return `Vorschau: ${bStr}<sup>?</sup>`;
            
            if (cStr === "" && bStr === "" && eStr === "") return "Vorschau: -";

            if (exp === 0) { // If exponent is 0, the term is just the coefficient (or 1 if no coeff)
                return `Vorschau: ${cStr === "" ? "1" : cStr}`;
            }
            
            let term = "";
            if (cStr !== "" && cStr !== "1" && cStr !== "-1") term += cStr;
            else if (cStr === "-1") term += "-";
            // If cStr is "1" or "", don't add "1" explicitly unless it's the only thing.
            else if (cStr === "1" && bStr === "") term += "1"; // Only coeff 1
            else if (cStr === "-1" && bStr === "") term += "-1"; // Only coeff -1


            if (bStr !== "") { // If there is a base
                if (term !== "" && term !== "-") term += " * "; // Add multiplication sign if there's a coeff other than 1 or -1
                term += bStr;
                if (eStr !== "" && eStr !== "1") term += `<sup>${eStr}</sup>`; // Add exponent if not 1
            } else if (term === "") { // No coefficient, no base, but maybe an exponent was entered (invalid state)
                 if (eStr !== "") return "Vorschau: - (Basis fehlt)"; // Needs a base if there's an exponent
                 term = "Vorschau: -";
            }


            return `Vorschau: ${term === "" ? (cStr === "" ? "-" : cStr) : term}`;
        }
        
        function formatSolutionForDisplay(coeff, base, exp) {
            if (exp === 0) return `${coeff}`; // If exp is 0, result is just the coefficient
            if (coeff === 0) return "0"; // If coeff is 0, result is 0

            let term = "";
            if (coeff === 1 && exp !== 0) term = ""; // No "1" if there's a base and exp is not 0
            else if (coeff === -1 && exp !== 0) term = "-"; // Only "-" if there's a base and exp is not 0
            else term = coeff.toString();
            
            // Add multiplication sign if coeff is present and not just a sign, and there's a base
            if (term !== "" && term !== "-" && base !== "") term += " * ";
            
            // Handle cases where only coeff is 1 or -1 and no base (e.g. solution is just 1 or -1 from x^0)
            if (base === "" && (coeff === 1 || coeff === -1) && exp === 0) return coeff.toString();


            term += base; // Add base
            if (exp !== 1) term += `<sup>${exp}</sup>`; // Add exponent if not 1
            return term;
        }


        function updateUserInputPreview() {
            const coeff = document.getElementById('coeffInput').value === "" ? NaN : parseInt(document.getElementById('coeffInput').value);
            const base = document.getElementById('baseInput').value.trim().toLowerCase();
            const exp = document.getElementById('expInput').value === "" ? NaN : parseInt(document.getElementById('expInput').value);
            document.getElementById('userInputPreview').innerHTML = formatTermPreview(coeff, base, exp);
        }

        document.getElementById('coeffInput').addEventListener('input', updateUserInputPreview);
        document.getElementById('baseInput').addEventListener('input', updateUserInputPreview);
        document.getElementById('expInput').addEventListener('input', updateUserInputPreview);


        function generateTask() {
            const tasksForCurrentLevel = tasksByLevel[currentLevel];
            if (!tasksForCurrentLevel || tasksForCurrentLevel.length === 0) {
                document.getElementById('task').innerHTML = "Keine Aufgaben für dieses Level verfügbar.";
                currentTask = {};
                return;
            }

            if (usedTasksIndices[currentLevel].length >= tasksForCurrentLevel.length) {
                usedTasksIndices[currentLevel] = []; 
            }

            let taskIndex;
            do {
                taskIndex = Math.floor(Math.random() * tasksForCurrentLevel.length);
            } while (usedTasksIndices[currentLevel].includes(taskIndex) && tasksForCurrentLevel.length > usedTasksIndices[currentLevel].length); // Ensure not to get stuck if all tasks used and list is small
            
            if (tasksForCurrentLevel.length > usedTasksIndices[currentLevel].length) { // Only add if not all tasks are used
                 usedTasksIndices[currentLevel].push(taskIndex);
            } else if (tasksForCurrentLevel.length === 1) { // If only one task, always pick it.
                taskIndex = 0;
            }


            currentTask = tasksForCurrentLevel[taskIndex];

            document.getElementById('task').innerHTML = currentTask.text;
            console.log("Generated Task:", currentTask);
        }

        function checkAnswer() {
            const userCoeffText = document.getElementById('coeffInput').value;
            const userBase = document.getElementById('baseInput').value.trim().toLowerCase();
            const userExpText = document.getElementById('expInput').value;
            const feedbackEl = document.getElementById('feedback');

            if (userCoeffText === "" || userBase === "" || userExpText === "") {
                feedbackEl.textContent = "Bitte fülle alle Felder aus (Vorzahl, Basis, Exponent).";
                feedbackEl.className = 'feedback feedback-incorrect';
                feedbackEl.classList.remove('hidden');
                return;
            }

            const userCoeff = parseInt(userCoeffText);
            const userExp = parseInt(userExpText);
            
            if (isNaN(userCoeff) || isNaN(userExp)) {
                 feedbackEl.textContent = "Vorzahl und Exponent müssen Zahlen sein.";
                feedbackEl.className = 'feedback feedback-incorrect';
                feedbackEl.classList.remove('hidden');
                return;
            }

            const sol = currentTask.solution;
            let isCorrect = (userCoeff === sol.coeff && userBase === sol.base && userExp === sol.exp);
            
            // Special case: if solution coefficient is 0, the base and exponent don't really matter for the value 0.
            // However, for consistency of the "form" of the power, we still expect the original base.
            // The exponent could be anything if coeff is 0, but we'll stick to the calculated one.
            if (sol.coeff === 0) {
                isCorrect = (userCoeff === 0 && userBase === sol.base && userExp === sol.exp);
            }


            if (isCorrect) {
                feedbackEl.innerHTML = `Korrekt! Die Lösung ist ${formatSolutionForDisplay(sol.coeff, sol.base, sol.exp)}.`;
                feedbackEl.className = 'feedback feedback-correct';
            } else {
                feedbackEl.innerHTML = `Leider falsch. Die richtige Lösung wäre ${formatSolutionForDisplay(sol.coeff, sol.base, sol.exp)}. Versuche es erneut oder generiere eine neue Aufgabe.`;
                feedbackEl.className = 'feedback feedback-incorrect';
            }
            feedbackEl.classList.remove('hidden');
        }

        function generateNewTask() {
            generateTask();
            document.getElementById('coeffInput').value = '';
            document.getElementById('baseInput').value = '';
            document.getElementById('expInput').value = '';
            document.getElementById('feedback').classList.add('hidden');
            updateUserInputPreview(); 
            document.getElementById('coeffInput').focus();
        }

        function selectLevel(level) {
            currentLevel = level;
            // usedTasksIndices[currentLevel] = []; // Resetting here makes sense if user switches level often
            document.querySelectorAll('.difficulty-btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('level' + level).classList.add('active');
            generateNewTask(); 
        }

        window.onload = () => {
            selectLevel(1); 
            updateUserInputPreview(); 
        };
    </script>

</body>
</html>
