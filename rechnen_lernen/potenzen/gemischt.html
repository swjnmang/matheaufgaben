<!DOCTYPE html>
<html lang="de" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potenzterme Zusammenfassen - gemischte Übungsaufgaben</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .math-term {
            font-family: 'Times New Roman', Times, serif; /* Keep for math */
            font-size: 1.3em;
            letter-spacing: 1px;
            line-height: 1.8;
            word-break: break-all;
        }
        .math-term sup {
            font-size: 0.75em; vertical-align: super; margin-left: 1px;
        }

        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Focus states for better accessibility and Apple-like feel */
        .input-field:focus-visible, .btn:focus-visible, .theme-switch input:focus-visible + .slider {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); /* Tailwind's blue-500 focus ring, adjust as needed */
        }
        .dark .input-field:focus-visible, .dark .btn:focus-visible, .dark .theme-switch input:focus-visible + .slider {
             box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.4); /* Tailwind's blue-400 for dark mode */
        }


        /* Dark mode toggle switch styling */
        .theme-switch-wrapper {
            position: fixed; /* Fixed position for page scroll */
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.7); /* Light mode background with transparency */
            border-radius: 9999px; /* pill shape */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px); /* Frosted glass effect */
        }
        .dark .theme-switch-wrapper {
            background-color: rgba(30, 41, 59, 0.7); /* slate-800 with transparency for dark mode */
        }

        .theme-switch {
            display: inline-block;
            height: 22px;
            position: relative;
            width: 40px;
            margin: 0 0.5rem;
        }
        .theme-switch input { display:none; }
        .slider {
            background-color: #e5e7eb; /* gray-200 */
            bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s;
        }
        .dark .slider {
            background-color: #374151; /* gray-700 */
        }
        .slider:before {
            background-color: #fff; /* white */
            bottom: 2px; content: ""; height: 18px; left: 2px; position: absolute; transition: .4s; width: 18px;
        }
        .dark .slider:before {
            background-color: #e5e7eb; /* gray-200 */
        }
        input:checked + .slider { background-color: #3b82f6; } /* blue-500 */
        .dark input:checked + .slider { background-color: #60a5fa; } /* blue-400 */

        input:checked + .slider:before { transform: translateX(18px); }
        .slider.round { border-radius: 22px; }
        .slider.round:before { border-radius: 50%; }

        .solution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1rem;
            align-items: end;
        }
    </style>
    <script>
        tailwind.config = {
          darkMode: 'class',
          theme: {
            extend: {
              fontFamily: {
                sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', "Noto Sans", 'sans-serif', "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
              },
              colors: {
                // Light theme (Apple-inspired)
                primary: { DEFAULT: '#007AFF', hover: '#0056b3' }, // Apple Blue
                secondary: { DEFAULT: '#8E8E93', hover: '#6D6D72' }, // Apple Gray
                background: '#F9F9FB', // Off-white
                card: '#FFFFFF',
                text: { primary: '#1D1D1F', secondary: '#6E6E73', muted: '#8A8A8E' },
                border: '#D1D1D6',
                // Dark theme
                dark_primary: { DEFAULT: '#0A84FF', hover: '#3395ff' }, // Apple Blue (Dark)
                dark_secondary: { DEFAULT: '#8E8E93', hover: '#A0A0A5' }, // Apple Gray (Dark)
                dark_background: '#1C1C1E', // Near Black
                dark_card: '#2C2C2E',
                dark_text: { primary: '#F5F5F7', secondary: '#A0A0A5', muted: '#636366' },
                dark_border: '#3A3A3C',
              }
            }
          }
        }
      </script>
</head>
<body class="bg-background dark:bg-dark_background text-text-primary dark:text-dark_text-primary min-h-screen flex flex-col items-center justify-center p-4 selection:bg-primary selection:text-white dark:selection:bg-dark_primary">

    <div class="theme-switch-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-muted dark:text-dark_text-muted">
            <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <label class="theme-switch" for="darkModeToggle">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider round"></span>
        </label>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-muted dark:text-dark_text-muted">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </div>

    <main class="task-card w-full max-w-3xl bg-card dark:bg-dark_card border border-border dark:border-dark_border rounded-xl shadow-2xl p-6 md:p-10">
        <h1 class="text-3xl md:text-4xl font-semibold text-center text-text-primary dark:text-dark_text-primary mb-8 md:mb-12">Potenzterme zusammenfassen</h1>
        <p class="text-center text-text-secondary dark:text-dark_text-secondary text-lg mb-10 md:mb-12 -mt-6 md:-mt-8">Gemischte Übungsaufgaben</p>

        <div class="mb-10">
            <label class="input-label text-md font-medium text-center text-text-secondary dark:text-dark_text-secondary mb-3">Schwierigkeitsstufe wählen:</label>
            <div class="flex flex-wrap justify-center gap-3">
                <button id="level1" class="btn text-sm font-medium py-2.5 px-5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 active:bg-primary active:text-white dark:active:bg-dark_primary dark:active:text-dark_text-primary" onclick="selectLevel(1)">Leicht</button>
                <button id="level2" class="btn text-sm font-medium py-2.5 px-5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 active:bg-primary active:text-white dark:active:bg-dark_primary dark:active:text-dark_text-primary" onclick="selectLevel(2)">Mittel</button>
                <button id="level3" class="btn text-sm font-medium py-2.5 px-5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 active:bg-primary active:text-white dark:active:bg-dark_primary dark:active:text-dark_text-primary" onclick="selectLevel(3)">Schwer</button>
                <button id="level4" class="btn text-sm font-medium py-2.5 px-5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 active:bg-primary active:text-white dark:active:bg-dark_primary dark:active:text-dark_text-primary" onclick="selectLevel(4)">Experte</button>
            </div>
        </div>

        <div class="bg-slate-50 dark:bg-dark_card border border-border dark:border-dark_border rounded-xl p-5 md:p-6 mb-8 shadow-inner">
            <h2 class="text-lg font-medium text-text-secondary dark:text-dark_text-secondary mb-3">Aufgabe:</h2>
            <p id="task" class="text-2xl md:text-3xl text-center font-mono py-6 bg-white dark:bg-slate-800 rounded-lg math-term text-text-primary dark:text-dark_text-primary shadow-sm">-</p>
        </div>

        <div class="mb-8">
            <h2 class="text-lg font-medium text-text-secondary dark:text-dark_text-secondary mb-4">Deine Lösung:</h2>
            <div class="solution-grid mb-3">
                <div>
                    <label for="coeffInput" class="input-label text-sm font-normal text-text-muted dark:text-dark_text-muted mb-1.5">Vorzahl / Koeffizient:</label>
                    <input type="number" step="any" id="coeffInput" class="input-field text-base bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-dark_border text-text-primary dark:text-dark_text-primary placeholder-text-muted dark:placeholder-dark_text-muted rounded-md py-2.5 px-3.5 focus:border-primary dark:focus:border-dark_primary" placeholder="z.B. 6">
                </div>
                <div>
                    <label for="base1Input" class="input-label text-sm font-normal text-text-muted dark:text-dark_text-muted mb-1.5">Basis 1:</label>
                    <input type="text" id="base1Input" class="input-field text-base bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-dark_border text-text-primary dark:text-dark_text-primary placeholder-text-muted dark:placeholder-dark_text-muted rounded-md py-2.5 px-3.5 focus:border-primary dark:focus:border-dark_primary" placeholder="z.B. x" maxlength="1">
                </div>
                <div>
                    <label for="exp1Input" class="input-label text-sm font-normal text-text-muted dark:text-dark_text-muted mb-1.5">Exponent 1:</label>
                    <input type="number" step="any" id="exp1Input" class="input-field text-base bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-dark_border text-text-primary dark:text-dark_text-primary placeholder-text-muted dark:placeholder-dark_text-muted rounded-md py-2.5 px-3.5 focus:border-primary dark:focus:border-dark_primary" placeholder="z.B. 5">
                </div>
                <div id="base2Container" class="hidden">
                    <label for="base2Input" class="input-label text-sm font-normal text-text-muted dark:text-dark_text-muted mb-1.5">Basis 2:</label>
                    <input type="text" id="base2Input" class="input-field text-base bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-dark_border text-text-primary dark:text-dark_text-primary placeholder-text-muted dark:placeholder-dark_text-muted rounded-md py-2.5 px-3.5 focus:border-primary dark:focus:border-dark_primary" placeholder="z.B. y" maxlength="1">
                </div>
                <div id="exp2Container" class="hidden">
                    <label for="exp2Input" class="input-label text-sm font-normal text-text-muted dark:text-dark_text-muted mb-1.5">Exponent 2:</label>
                    <input type="number" step="any" id="exp2Input" class="input-field text-base bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-dark_border text-text-primary dark:text-dark_text-primary placeholder-text-muted dark:placeholder-dark_text-muted rounded-md py-2.5 px-3.5 focus:border-primary dark:focus:border-dark_primary" placeholder="z.B. 3">
                </div>
            </div>
            <div id="userInputPreview" class="math-term border border-dashed border-border dark:border-dark_border text-text-muted dark:text-dark_text-muted rounded-md p-3 text-center">Vorschau: -</div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-10">
            <button onclick="checkAnswer()" class="btn text-base font-semibold py-3 px-6 rounded-lg bg-primary hover:bg-primary-hover dark:bg-dark_primary dark:hover:bg-dark_primary-hover text-white w-full sm:w-auto shadow-md hover:shadow-lg">Antwort prüfen</button>
            <button onclick="generateNewTask()" class="btn text-base font-medium py-3 px-6 rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-100 hover:bg-slate-300 dark:hover:bg-slate-500 w-full sm:w-auto">Neue Aufgabe</button>
        </div>

        <div id="feedback" class="feedback hidden mt-6 p-4 rounded-lg text-sm"></div>
    </main>

    <script>
        let currentTaskFull = {}; 
        let currentLevel = 1;
        let usedTasksIndices = { 1: [], 2: [], 3: [], 4: [] }; 
        const availableBases = ['a', 'b', 'c', 'm', 'n', 'p', 'x', 'y', 'z'];

        const darkModeToggle = document.getElementById('darkModeToggle');
        const htmlElement = document.documentElement;

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            htmlElement.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                htmlElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                htmlElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });

        function getRandomBase(excludeBase = null) {
            let filteredBases = availableBases;
            if (excludeBase) {
                filteredBases = availableBases.filter(b => b !== excludeBase);
            }
            return filteredBases[Math.floor(Math.random() * filteredBases.length)];
        }
        
        const taskTemplatesByLevel = {
            1: [ 
                { text: (b1) => `${b1}<sup>2</sup> * ${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 5 }), hint: "Potenzen mit gleicher Basis werden multipliziert, indem man die Exponenten addiert." },
                { text: (b1) => `${b1}<sup>5</sup> / ${b1}<sup>2</sup>`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 3 }), hint: "Potenzen mit gleicher Basis werden dividiert, indem man die Exponenten subtrahiert." },
                { text: (b1) => `(${b1}<sup>3</sup>)<sup>2</sup>`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 6 }), hint: "Eine Potenz wird potenziert, indem man die Exponenten multipliziert." },
                { text: (b1) => `2${b1}<sup>4</sup> + 3${b1}<sup>4</sup>`, solution: (b1) => ({ coeff: 5, base1: b1, exp1: 4 }), hint: "Potenzen mit gleicher Basis und gleichem Exponenten können addiert werden, indem man die Koeffizienten addiert." },
                { text: (b1) => `7${b1}<sup>3</sup> - 4${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 3, base1: b1, exp1: 3 }), hint: "Potenzen mit gleicher Basis und gleichem Exponenten können subtrahiert werden, indem man die Koeffizienten subtrahiert." },
                { text: (b1) => `(${b1}<sup>2</sup> * ${b1}<sup>4</sup>) / ${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 3 }), hint: "Kombiniere die Regeln: Zuerst im Zähler multiplizieren, dann dividieren." },
                { text: (b1) => `6${b1}<sup>5</sup> / (2${b1}<sup>2</sup>)`, solution: (b1) => ({ coeff: 3, base1: b1, exp1: 3 }), hint: "Dividiere die Koeffizienten und subtrahiere die Exponenten." },
                { text: (b1) => `4${b1}<sup>2</sup> * 2${b1}<sup>0</sup>`, solution: (b1) => ({ coeff: 8, base1: b1, exp1: 2 }), hint: "Erinnere dich: Jede Basis (außer 0) hoch 0 ergibt 1." },
                { text: (b1) => `10${b1}<sup>7</sup> / ${b1}<sup>3</sup> - 3${b1}<sup>4</sup>`, solution: (b1) => ({ coeff: 7, base1: b1, exp1: 4 }), hint: "Erst dividieren, dann subtrahieren (Punkt vor Strich beachten)." },
                { text: (b1) => `(${b1}<sup>4</sup> / ${b1}<sup>1</sup>) + 5${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 6, base1: b1, exp1: 3 }), hint: "Erst dividieren, dann die gleichartigen Terme addieren." },
                { text: (b1) => `(3${b1}<sup>2</sup>)<sup>2</sup>`, solution: (b1) => ({ coeff: 9, base1: b1, exp1: 4 }), hint: "Sowohl der Koeffizient als auch die Potenz werden potenziert: (ab)<sup>n</sup> = a<sup>n</sup>b<sup>n</sup>." },
                { text: (b1) => `8${b1}<sup>3</sup> - ${b1}<sup>3</sup> + 2${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 9, base1: b1, exp1: 3 }), hint: "Addiere und subtrahiere die Koeffizienten der gleichartigen Terme." },
                { text: (b1) => `5${b1} * 3${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 15, base1: b1, exp1: 4 }), hint: "Multipliziere die Koeffizienten und addiere die Exponenten (vergiss nicht, dass ${b1} dasselbe ist wie ${b1}<sup>1</sup>)." },
                { text: (b1) => `12${b1}<sup>4</sup> / (4${b1})`, solution: (b1) => ({ coeff: 3, base1: b1, exp1: 3 }), hint: "Dividiere die Koeffizienten und subtrahiere die Exponenten." }
            ],
            2: [ 
                { text: (b1) => `2${b1}<sup>3</sup> * 3${b1}<sup>2</sup> + 4${b1}<sup>5</sup>`, solution: (b1) => ({ coeff: 10, base1: b1, exp1: 5 }), hint: "Multipliziere zuerst (Koeffizienten multiplizieren, Exponenten addieren), dann addiere." },
                { text: (b1) => `15${b1}<sup>6</sup> / (3${b1}<sup>2</sup>) - 2${b1}<sup>4</sup>`, solution: (b1) => ({ coeff: 3, base1: b1, exp1: 4 }), hint: "Dividiere zuerst (Koeffizienten dividieren, Exponenten subtrahieren), dann subtrahiere." },
                { text: (b1) => `(2${b1}<sup>2</sup>)<sup>3</sup> - 5${b1}<sup>6</sup>`, solution: (b1) => ({ coeff: 3, base1: b1, exp1: 6 }), hint: "Potenziere zuerst den Term in der Klammer, dann subtrahiere." }, 
                { text: (b1) => `(12${b1}<sup>6</sup> / (2${b1}<sup>2</sup>)) * 3${b1}<sup>1</sup> - 10${b1}<sup>5</sup>`, solution: (b1) => ({ coeff: 8, base1: b1, exp1: 5 }), hint: "Klammer zuerst: dividieren, dann multiplizieren, dann subtrahieren." }, 
                { text: (b1) => `3 * (4${b1}<sup>2</sup> - ${b1}<sup>2</sup>) + 2${b1}<sup>2</sup>`, solution: (b1) => ({ coeff: 11, base1: b1, exp1: 2 }), hint: "Klammer zuerst (Subtraktion), dann multiplizieren, dann addieren." }, 
                { text: (b1) => `(10${b1}<sup>4</sup> + 5${b1}<sup>4</sup>) / (3${b1}<sup>1</sup>)`, solution: (b1) => ({ coeff: 5, base1: b1, exp1: 3 }), hint: "Zuerst die Terme im Zähler addieren, dann dividieren." }, 
                { text: (b1) => `(3${b1}<sup>3</sup>)<sup>2</sup> + (2${b1}<sup>2</sup>)<sup>3</sup> - ${b1}<sup>6</sup>`, solution: (b1) => ({ coeff: 16, base1: b1, exp1: 6 }), hint: "Potenziere beide Klammerterme, dann addiere/subtrahiere die gleichartigen Terme." }, 
                { text: (b1) => `20${b1}<sup>7</sup> / (5${b1}<sup>0</sup> * 2${b1}<sup>3</sup>) + 3${b1}<sup>4</sup>`, solution: (b1) => ({ coeff: 5, base1: b1, exp1: 4 }), hint: "Beachte ${b1}<sup>0</sup>=1. Vereinfache den Nenner, dividiere, dann addiere." }, 
                { text: (b1) => `(4${b1} * 2${b1}<sup>2</sup>) - (${b1}<sup>4</sup> / ${b1}<sup>1</sup>) + 5${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 10, base1: b1, exp1: 3 }), hint: "Berechne die Terme in den Klammern getrennt (Punktrechnung), dann Strichrechnung." }, 
                { text: (b1) => `( (2${b1})<sup>3</sup> * ${b1}<sup>2</sup> ) / (4${b1}) - ${b1}<sup>4</sup>`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 4 }), hint: "Potenziere, multipliziere im Zähler, dividiere, dann subtrahiere."},
                { text: (b1) => `(6${b1}<sup>2</sup> - 2${b1}<sup>2</sup>) * 3${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 12, base1: b1, exp1: 5 }), hint: "Klammer zuerst (Subtraktion), dann multiplizieren." },
                { text: (b1) => `2${b1} * (5${b1}<sup>3</sup> - ${b1}<sup>3</sup>) / ${b1}<sup>2</sup>`, solution: (b1) => ({ coeff: 8, base1: b1, exp1: 2 }), hint: "Klammer zuerst, dann multiplizieren, dann dividieren." }
            ],
            3: [ 
                { text: (b1) => `((2${b1}<sup>2</sup>)<sup>3</sup> * 3${b1}) / (6${b1}<sup>5</sup>) + 2${b1}<sup>2</sup>`, solution: (b1) => ({ coeff: 6, base1: b1, exp1: 2 }), hint: "Potenzieren, multiplizieren, dividieren, dann addieren. Achte auf die Reihenfolge." }, 
                { text: (b1) => `( (5${b1}<sup>3</sup>)<sup>2</sup> - 10${b1}<sup>6</sup> ) / (3${b1}<sup>2</sup> * ${b1}<sup>1</sup>) + ${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 6, base1: b1, exp1: 3 }), hint: "Klammern zuerst: Potenzieren, Subtrahieren im Zähler. Multiplizieren im Nenner. Dann dividieren und addieren." }, 
                { text: (b1) => `2 * ( (3${b1}<sup>2</sup>)<sup>2</sup> + ${b1}<sup>4</sup> ) / (5${b1}<sup>3</sup>) - ${b1}`, solution: (b1) => ({ coeff: 3, base1: b1, exp1: 1 }), hint: "Innerste Klammer potenzieren, addieren, dann mit 2 multiplizieren, dividieren, und schließlich subtrahieren." }, 
                { text: (b1) => `((4${b1}<sup>3</sup> * 2${b1}<sup>2</sup>) / ${b1}<sup>0</sup>) - ( (2${b1}) * (4${b1}<sup>4</sup>) )`, solution: (b1) => ({ coeff: 0, base1: b1, exp1: 5 }), hint: "Beachte ${b1}<sup>0</sup>=1. Ein Ergebnis von 0 ist möglich!" },
                { text: (b1) => `( ( (2${b1}<sup>3</sup>)<sup>4</sup> / (4${b1}<sup>2</sup>) ) - 2${b1}<sup>10</sup> ) * 3`, solution: (b1) => ({ coeff: 6, base1: b1, exp1: 10 }), hint: "Von innen nach außen: Potenzieren, dividieren, subtrahieren, dann multiplizieren." }, 
                { text: (b1) => `(5${b1}<sup>2</sup> + (3${b1})<sup>2</sup> - 3${b1}<sup>2</sup>) / (11${b1}<sup>1</sup>)`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 1 }), hint: "Potenzieren, dann im Zähler addieren/subtrahieren, dann dividieren." }, 
                { text: (b1) => `( (2${b1}<sup>5</sup> * 6${b1}<sup>2</sup>) / (3${b1}<sup>3</sup>) ) + (4${b1}<sup>0</sup> * ${b1}<sup>4</sup>) - ${b1}<sup>4</sup>`, solution: (b1) => ({ coeff: 4, base1: b1, exp1: 4 }), hint: "Links: multiplizieren, dann dividieren. Mitte: ${b1}<sup>0</sup> beachten. Rechts: Term. Dann alles addieren/subtrahieren."},
                { text: (b1) => `( (10${b1}<sup>3</sup> / (2${b1}))<sup>2</sup> + 5${b1}<sup>4</sup> ) / (3${b1}<sup>2</sup>)`, solution: (b1) => ({ coeff: 10, base1: b1, exp1: 2 }), hint: "Innerste Klammer dividieren, dann quadrieren, addieren, und schließlich dividieren."}, 
                { text: (b1) => `3${b1} * ( (2${b1}<sup>2</sup>)<sup>3</sup> / (4${b1}<sup>4</sup>) ) - 5${b1}<sup>3</sup>`, solution: (b1) => ({ coeff: 1, base1: b1, exp1: 3 }), hint: "Klammer: Potenzieren, dann dividieren. Dann mit 3${b1} multiplizieren und subtrahieren."} 
            ],
            4: [ 
                { text: (b1, b2) => `2${b1}<sup>2</sup>${b2}<sup>3</sup> * 3${b1}<sup>4</sup>${b2}<sup>1</sup>`, solution: (b1, b2) => ({ coeff: 6, base1: b1, exp1: 6, base2: b2, exp2: 4 }), hint: "Multipliziere Koeffizienten. Addiere Exponenten für jede Basis getrennt." },
                { text: (b1, b2) => `(10${b1}<sup>5</sup>${b2}<sup>2</sup>) / (2${b1}<sup>2</sup>${b2}<sup>1</sup>)`, solution: (b1, b2) => ({ coeff: 5, base1: b1, exp1: 3, base2: b2, exp2: 1 }), hint: "Dividiere Koeffizienten. Subtrahiere Exponenten für jede Basis getrennt." },
                { text: (b1, b2) => `(2${b1}${b2}<sup>3</sup>)<sup>3</sup>`, solution: (b1, b2) => ({ coeff: 8, base1: b1, exp1: 3, base2: b2, exp2: 9 }), hint: "Potenziere den Koeffizienten und jeden Faktor in der Klammer." },
                { text: (b1, b2) => `3${b1}<sup>2</sup>${b2} * 4${b1}<sup>1</sup>${b2}<sup>3</sup> + 2${b1}<sup>3</sup>${b2}<sup>4</sup>`, solution: (b1, b2) => ({ coeff: 14, base1: b1, exp1: 3, base2: b2, exp2: 4 }), hint: "Multipliziere den ersten Term aus, dann addiere die gleichartigen Terme." }, 
                { text: (b1, b2) => `( (6${b1}<sup>4</sup>${b2}<sup>5</sup>) / (3${b1}<sup>2</sup>${b2}<sup>2</sup>) ) * 2${b1}${b2} - 3${b1}<sup>3</sup>${b2}<sup>4</sup>`, solution: (b1, b2) => ({ coeff: 1, base1: b1, exp1: 3, base2: b2, exp2: 4 }), hint: "Klammer zuerst (Division), dann multiplizieren, dann subtrahieren." }, 
                { text: (b1, b2) => `( ${b1}<sup>2</sup>${b2}<sup>0</sup> * 5${b1}<sup>3</sup>${b2}<sup>4</sup> ) / ${b2}<sup>2</sup>`, solution: (b1, b2) => ({ coeff: 5, base1: b1, exp1: 5, base2: b2, exp2: 2 }), hint: "Beachte ${b2}<sup>0</sup>=1. Multipliziere im Zähler, dann dividiere (Exponenten von ${b2} beachten)." }, 
                { text: (b1, b2) => `(2${b1}<sup>2</sup>${b2})<sup>3</sup> * (${b1}${b2}<sup>2</sup>)<sup>2</sup>`, solution: (b1, b2) => ({ coeff: 8, base1: b1, exp1: 8, base2: b2, exp2: 7 }), hint: "Potenziere beide Klammern zuerst, dann multipliziere die Ergebnisse." }, 
                { text: (b1, b2) => `(12${b1}<sup>3</sup>${b2}<sup>3</sup> + 8${b1}<sup>3</sup>${b2}<sup>3</sup>) / (5${b1}${b2})`, solution: (b1, b2) => ({ coeff: 4, base1: b1, exp1: 2, base2: b2, exp2: 2 }), hint: "Addiere im Zähler, dann dividiere." },
                { text: (b1, b2) => `(3${b1}${b2}<sup>2</sup>)<sup>2</sup> * (2${b1}<sup>0</sup>${b2}) / (${b1}${b2}<sup>3</sup>)`, solution: (b1, b2) => ({ coeff: 18, base1: b1, exp1: 1, base2: b2, exp2: 2 }), hint: "Potenzieren, ${b1}<sup>0</sup> beachten, multiplizieren, dann dividieren." }, 
                { text: (b1, b2) => `(10${b1}<sup>4</sup>${b2} - 5${b1}<sup>4</sup>${b2}) * (2${b1}${b2}<sup>2</sup>) / (5${b1}<sup>3</sup>${b2})`, solution: (b1, b2) => ({ coeff: 2, base1: b1, exp1: 2, base2: b2, exp2: 2 }), hint: "Klammer zuerst, dann multiplizieren, dann dividieren." } 
            ]
        };


        function formatTermPreview(coeff, base1, exp1, base2, exp2) {
            let cStr = isNaN(coeff) || coeff === "" ? "" : Number(coeff).toString();
            let b1Str = base1 === "" ? "" : base1;
            let e1Str = isNaN(exp1) || exp1 === "" ? "" : Number(exp1).toString();
            let b2Str = base2 === "" || base2 === null ? "" : base2;
            let e2Str = isNaN(exp2) || exp2 === "" || exp2 === null ? "" : Number(exp2).toString();

            if (cStr==="" && b1Str==="" && e1Str==="" && b2Str==="" && e2Str==="") return "Vorschau: -";
            
            let term = "";
            let hasContent = false;

            if (cStr !== "") {
                if (cStr === "1" && (b1Str !== "" || b2Str !== "")) { /* implicit 1 */ }
                else if (cStr === "-1" && (b1Str !== "" || b2Str !== "")) { term = "-"; }
                else { term = cStr; }
                hasContent = true;
            }

            if (b1Str !== "") {
                if (term !== "" && term !== "-") term += " * ";
                term += b1Str;
                if (e1Str !== "" && e1Str !== "1") term += `<sup>${e1Str}</sup>`;
                else if (e1Str === "" && b1Str !== "") term += `<sup>?</sup>`;
                hasContent = true;
            } else if (e1Str !== "" && e1Str !== "0") {
                 if (term !== "" && term !== "-") term += " * ";
                 term += `?<sup>${e1Str}</sup>`;
                 hasContent = true;
            }

            if (b2Str !== "") {
                if (term !== "" && term !== "-") term += " * ";
                else if (term === "-" && cStr === "-1" && b1Str === "") { /* ok */ }
                else if (term === "" && (cStr === "1" || cStr === "") && b1Str === "") { /* ok */ }


                term += b2Str;
                if (e2Str !== "" && e2Str !== "1") term += `<sup>${e2Str}</sup>`;
                 else if (e2Str === "" && b2Str !== "") term += `<sup>?</sup>`;
                hasContent = true;
            } else if (e2Str !== "" && e2Str !== "0") {
                 if (term !== "" && term !== "-") term += " * ";
                 term += `?<sup>${e2Str}</sup>`;
                 hasContent = true;
            }
            
            if (!hasContent && cStr !== "") { 
                term = cStr;
            } else if (term === "" && cStr === "") { 
                 return "Vorschau: -";
            }
            return `Vorschau: ${term === "" ? (cStr === "" ? "-" : cStr) : term}`;
        }
        
        function formatSolutionForDisplay(sol) {
            if (sol.coeff === 0) return "0 (Der gesamte Term vereinfacht sich zu 0)";

            let term = "";
            if (sol.coeff === 1 && (sol.base1 || sol.base2)) { /* no "1" */ }
            else if (sol.coeff === -1 && (sol.base1 || sol.base2)) { term = "-"; }
            else { term = sol.coeff.toString(); }

            if (sol.base1) {
                if (term !== "" && term !== "-") term += " * ";
                term += sol.base1;
                if (sol.exp1 !== 1) term += `<sup>${sol.exp1}</sup>`;
            }

            if (sol.base2) {
                if (term !== "" && term !== "-") { 
                     if (sol.base1 || (sol.coeff !== 1 && sol.coeff !== -1) || ( (sol.coeff === 1 || sol.coeff === -1) && !sol.base1 ) ) { 
                        term += " * ";
                    }
                } else if (term === "-" && !sol.base1) { /* ok */ }
                 else if (term === "" && !sol.base1 && sol.coeff === 1) { /* ok */ }


                term += sol.base2;
                if (sol.exp2 !== 1) term += `<sup>${sol.exp2}</sup>`;
            }
            
            if(term === "") return sol.coeff.toString(); 
            return term;
        }

        function updateUserInputPreview() {
            const coeff = document.getElementById('coeffInput').value === "" ? NaN : parseFloat(document.getElementById('coeffInput').value);
            const base1 = document.getElementById('base1Input').value.trim().toLowerCase();
            const exp1 = document.getElementById('exp1Input').value === "" ? NaN : parseFloat(document.getElementById('exp1Input').value);
            
            let base2 = "", exp2 = NaN;
            if (currentLevel === 4) {
                base2 = document.getElementById('base2Input').value.trim().toLowerCase();
                exp2 = document.getElementById('exp2Input').value === "" ? NaN : parseFloat(document.getElementById('exp2Input').value);
            }
            document.getElementById('userInputPreview').innerHTML = formatTermPreview(coeff, base1, exp1, base2, exp2);
        }

        document.getElementById('coeffInput').addEventListener('input', updateUserInputPreview);
        document.getElementById('base1Input').addEventListener('input', updateUserInputPreview);
        document.getElementById('exp1Input').addEventListener('input', updateUserInputPreview);
        document.getElementById('base2Input').addEventListener('input', updateUserInputPreview); 
        document.getElementById('exp2Input').addEventListener('input', updateUserInputPreview); 


        function generateTask() {
            const base1 = getRandomBase();
            let base2 = null;
            if (currentLevel === 4) {
                base2 = getRandomBase(base1); 
            }

            const taskTemplates = taskTemplatesByLevel[currentLevel];
            if (!taskTemplates || taskTemplates.length === 0) {
                document.getElementById('task').innerHTML = "Keine Aufgaben für dieses Level verfügbar.";
                currentTaskFull = {}; return;
            }

            if (usedTasksIndices[currentLevel].length >= taskTemplates.length) {
                usedTasksIndices[currentLevel] = []; 
            }

            let templateIndex;
            do {
                templateIndex = Math.floor(Math.random() * taskTemplates.length);
            } while (usedTasksIndices[currentLevel].includes(templateIndex) && taskTemplates.length > usedTasksIndices[currentLevel].length);
            
            if (taskTemplates.length > usedTasksIndices[currentLevel].length) {
                 usedTasksIndices[currentLevel].push(templateIndex);
            } else if (taskTemplates.length === 1) {
                templateIndex = 0;
            }

            const selectedTemplate = taskTemplates[templateIndex];
            currentTaskFull = {
                text: selectedTemplate.text(base1, base2), 
                solution: selectedTemplate.solution(base1, base2),
                hint: selectedTemplate.hint
            };

            document.getElementById('task').innerHTML = currentTaskFull.text;
            const base2Container = document.getElementById('base2Container');
            const exp2Container = document.getElementById('exp2Container');
            if (currentLevel === 4) {
                base2Container.classList.remove('hidden');
                exp2Container.classList.remove('hidden');
            } else {
                base2Container.classList.add('hidden');
                exp2Container.classList.add('hidden');
                document.getElementById('base2Input').value = ''; 
                document.getElementById('exp2Input').value = '';
            }
            updateUserInputPreview(); 
            console.log("Generated Task:", currentTaskFull);
        }

        function checkAnswer() {
            const userCoeffText = document.getElementById('coeffInput').value;
            const userBase1 = document.getElementById('base1Input').value.trim().toLowerCase();
            const userExp1Text = document.getElementById('exp1Input').value;
            const feedbackEl = document.getElementById('feedback');

            let userBase2 = null, userExp2Text = null, userExp2 = null;
            if (currentLevel === 4) {
                userBase2 = document.getElementById('base2Input').value.trim().toLowerCase();
                userExp2Text = document.getElementById('exp2Input').value;
            }

            let essentialFieldsMissing = userCoeffText === "" || userBase1 === "" || userExp1Text === "";
            if (currentLevel === 4 && currentTaskFull.solution.base2) { 
                if (userBase2 === "" || userExp2Text === "") {
                    essentialFieldsMissing = true;
                }
            }

            if (essentialFieldsMissing) {
                let message = "Bitte fülle alle relevanten Felder aus (Vorzahl / Koeffizient, Basis 1, Exponent 1";
                if (currentLevel === 4 && currentTaskFull.solution.base2) {
                    message += ", Basis 2, Exponent 2";
                }
                message += ").";
                feedbackEl.textContent = message;
                feedbackEl.className = 'feedback feedback-incorrect bg-red-100 dark:bg-dark_card border-red-300 dark:border-red-500 text-red-700 dark:text-red-300';
                feedbackEl.classList.remove('hidden');
                return;
            }
            
            const userCoeff = parseFloat(userCoeffText);
            const userExp1 = parseFloat(userExp1Text);
            if (currentLevel === 4 && userExp2Text !== null && userExp2Text !== "") {
                userExp2 = parseFloat(userExp2Text);
            }

            let numbersInvalid = isNaN(userCoeff) || isNaN(userExp1);
            if (currentLevel === 4 && currentTaskFull.solution.base2 && isNaN(userExp2)) {
                numbersInvalid = true;
            }

            if (numbersInvalid) {
                 feedbackEl.textContent = "Vorzahl / Koeffizient und Exponent(en) müssen Zahlen sein.";
                feedbackEl.className = 'feedback feedback-incorrect bg-red-100 dark:bg-dark_card border-red-300 dark:border-red-500 text-red-700 dark:text-red-300';
                feedbackEl.classList.remove('hidden');
                return;
            }

            const sol = currentTaskFull.solution;
            let isCorrect = false;

            if (sol.coeff === 0) { 
                isCorrect = (userCoeff === 0); 
            } else if (currentLevel === 4) {
                const solHasBase2 = !!sol.base2;
                const userProvidedBase2 = userBase2 && userBase2 !== "";

                if (solHasBase2) { 
                    isCorrect = (userCoeff === sol.coeff &&
                                 ((userBase1 === sol.base1 && userExp1 === sol.exp1 && userBase2 === sol.base2 && userExp2 === sol.exp2) ||
                                  (userBase1 === sol.base2 && userExp1 === sol.exp2 && userBase2 === sol.base1 && userExp2 === sol.exp1)) 
                                );
                } else { 
                    isCorrect = (userCoeff === sol.coeff &&
                                 userBase1 === sol.base1 && userExp1 === sol.exp1 &&
                                 (!userProvidedBase2 || userBase2 === "") ); 
                }
            } else { 
                isCorrect = (userCoeff === sol.coeff && userBase1 === sol.base1 && userExp1 === sol.exp1);
            }

            if (isCorrect) {
                feedbackEl.innerHTML = `Korrekt! Die Lösung ist ${formatSolutionForDisplay(sol)}.`;
                feedbackEl.className = 'feedback feedback-correct bg-green-50 dark:bg-green-900/30 border-green-300 dark:border-green-700 text-green-700 dark:text-green-300';
            } else {
                let hintText = currentTaskFull.hint ? `<br><small class="text-text-secondary dark:text-dark_text-secondary">Tipp: ${currentTaskFull.hint}</small>` : "";
                feedbackEl.innerHTML = `Leider falsch. Die richtige Lösung wäre ${formatSolutionForDisplay(sol)}.${hintText}`;
                feedbackEl.className = 'feedback feedback-incorrect bg-red-50 dark:bg-red-900/30 border-red-300 dark:border-red-500 text-red-700 dark:text-red-300';
            }
            feedbackEl.classList.remove('hidden');
        }

        function generateNewTask() {
            generateTask(); 
            document.getElementById('coeffInput').value = '';
            document.getElementById('base1Input').value = '';
            document.getElementById('exp1Input').value = '';
            if (currentLevel === 4 || document.getElementById('base2Container').classList.contains('hidden') === false) {
                 document.getElementById('base2Input').value = '';
                 document.getElementById('exp2Input').value = '';
            }
            document.getElementById('feedback').classList.add('hidden');
            updateUserInputPreview(); 
            document.getElementById('coeffInput').focus();
        }

        function selectLevel(level) {
            currentLevel = level;
            usedTasksIndices[currentLevel] = []; 
            document.querySelectorAll('.difficulty-btn-group button').forEach(btn => {
                btn.classList.remove('active', 'bg-primary', 'text-white', 'dark:bg-dark_primary', 'dark:text-dark_text-primary');
                btn.classList.add('bg-slate-100', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'hover:bg-slate-200', 'dark:hover:bg-slate-600');
            });
            const activeButton = document.getElementById('level' + level);
            activeButton.classList.add('active', 'bg-primary', 'text-white', 'dark:bg-dark_primary', 'dark:text-dark_text-primary');
            activeButton.classList.remove('bg-slate-100', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'hover:bg-slate-200', 'dark:hover:bg-slate-600');


            generateNewTask(); 
        }

        window.onload = () => {
            const initialActiveButton = document.getElementById('level1');
            initialActiveButton.classList.add('active', 'bg-primary', 'text-white', 'dark:bg-dark_primary', 'dark:text-dark_text-primary');
            initialActiveButton.classList.remove('bg-slate-100', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200');
            
            selectLevel(1); 
            updateUserInputPreview(); 
        };
    </script>

</body>
</html>
