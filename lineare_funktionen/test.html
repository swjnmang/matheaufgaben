<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitale Prüfung: Lineare Funktionen</title>
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>
    <style>
        /* Modernes & ansprechendes Design */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #test-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px 30px;
            width: 100%;
            max-width: 700px;
            margin: 20px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        #test-container h2 {
            color: #333; margin-bottom: 20px; font-size: 1.5em;
        }
        /* Start & Result Screens */
        #start-screen, #result-screen {
            padding: 40px 20px;
        }
        #start-screen p { line-height: 1.6; }
        #start-screen div { margin-top: 20px; }
        #result-screen h3 {
            font-size: 1.8em; margin-bottom: 15px;
        }
        .score { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .grade { font-size: 1.5em; font-style: italic; color: #555; margin-bottom: 20px;}
        .feedback { line-height: 1.6; }
        #result-details {
            margin-top: 30px;
            text-align: left;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }
        .result-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .result-item p { margin: 5px 0; }
        .result-question { font-weight: bold; }
        .user-answer.incorrect, .correct-answer { color: #dc3545; }
        .user-answer.correct { color: #28a745; }
        .correct-icon { color: #28a745; font-weight: bold; }
        .wrong-icon { color: #dc3545; font-weight: bold; }

        /* Quiz Screen */
        #quiz-screen {
            display: none;
        }
        #progress-bar-container {
            width: 100%; background-color: #e0e0e0; border-radius: 10px; margin-bottom: 20px;
        }
        #progress-bar {
            width: 0%; height: 10px; background-color: #0073aa; border-radius: 10px; transition: width 0.3s ease;
        }
        #ggb-container {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            margin: 0 auto 20px auto;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dcdcdc;
        }
        #task-output {
            background-color: #f8f9fa; border: 1px solid #dcdcdc; border-radius: 8px;
            padding: 25px; margin-bottom: 20px; min-height: 80px;
            font-size: 1.1em; line-height: 1.6; color: #495057;
        }
        .task-data {
            font-size: 1.3em; font-weight: bold; color: #005a87;
            font-family: 'Courier New', Courier, monospace; display: block; margin-top: 10px;
        }
        .input-mask {
            margin: 20px 0; font-size: 1.5em;
            font-family: 'Courier New', Courier, monospace;
            display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;
        }
        .equation-input {
            padding: 10px; border-radius: 8px; border: 1px solid #ccc;
            font-size: 1em; width: 80px; text-align: center; font-family: inherit;
        }
        /* Buttons */
        .button-container {
            display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
        }
        .generator-button {
            background: linear-gradient(145deg, #0078b3, #005f8e); color: white;
            border: none; border-radius: 8px; padding: 12px 28px;
            font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
        }
        .generator-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .generator-button:disabled {
             background: linear-gradient(145deg, #c0c0c0, #a9a9a9);
             cursor: not-allowed;
        }
    </style>
</head>
<body>

<div id="test-container">
    <div id="start-screen">
        <h2>Digitale Prüfung: Lineare Funktionen</h2>
        <p>Dieser Test besteht aus 15 zufälligen Aufgaben zu allen wichtigen Themen der linearen Funktionen.</p>
        <p><b>Wichtiger Hinweis:</b> Halte bitte Stift und Papier bereit, um alle Berechnungen schriftlich festzuhalten.</p>
        <div>
            <input type="checkbox" id="confirm-read">
            <label for="confirm-read"> Ich habe die Information gelesen.</label>
        </div>
        <br>
        <button class="generator-button" id="start-test-btn" onclick="startTest()" disabled>Test starten</button>
    </div>

    <div id="quiz-screen">
        <h2>Aufgabe <span id="question-number">1</span></h2>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
        
        <div id="ggb-container" style="display: none;"><div id="ggb-element"></div></div>
        <div id="task-output"></div>
        
        <div id="input-mask-single" class="input-mask" style="display: none;">
            <span id="input-prefix"></span> <input type="text" id="single-input" class="equation-input">
        </div>
        <div id="input-mask-point" class="input-mask" style="display: none;">
            S( <input type="text" id="x-input" class="equation-input" placeholder="x"> | <input type="text" id="y-input" class="equation-input" placeholder="y"> )
            <div>
                <input type="checkbox" id="no-intersection-checkbox">
                <label for="no-intersection-checkbox" style="font-size: 0.6em; font-family: sans-serif;">Kein Schnittpunkt</label>
            </div>
        </div>
        <div id="input-mask-equation" class="input-mask" style="display: none;">
            y = <input type="text" id="m-input" class="equation-input" placeholder="m"> x + <input type="text" id="t-input" class="equation-input" placeholder="t">
        </div>

        <button class="generator-button" id="next-btn" onclick="saveAndNextQuestion()">Nächste Frage</button>
    </div>

    <div id="result-screen" style="display: none;">
        <h3>Dein Ergebnis</h3>
        <div id="score-display" class="score"></div>
        <div id="grade-display" class="grade"></div>
        <div id="feedback-display" class="feedback"></div>
        <hr>
        <h3>Detailauswertung:</h3>
        <div id="result-details"></div>
        <br>
        <button class="generator-button" onclick="startTest()">Neuen Test starten</button>
    </div>

</div>

<script>
    const TOTAL_QUESTIONS = 15;
    let questions = [];
    let currentQuestionIndex = 0;
    var ggbApplet;

    document.getElementById('confirm-read').addEventListener('change', function() {
        document.getElementById('start-test-btn').disabled = !this.checked;
    });

    const formatNumber = (num) => Math.round(num * 100) / 100;
    const randomInt = (max, min = 0) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];

    // --- QUESTION GENERATION LOGIC ---
    function createSlopeQuestion() {
        let x1, y1, x2, y2;
        do { x1 = randomInt(10, -10); x2 = randomInt(10, -10); } while (x1 === x2);
        y1 = randomInt(10, -10); y2 = randomInt(10, -10);
        return {
            type: 'slope',
            text: `Berechne die Steigung m der Geraden durch P₁(${x1}|${y1}) und P₂(${x2}|${y2}).`,
            data: {},
            answer: { m: formatNumber((y2 - y1) / (x2 - x1)) },
            answerFormat: 'single_number',
            inputPrefix: 'm ='
        };
    }

    function createMissingCoordinateQuestion() {
        const m = randomInt(5, -5) || 1;
        const t = randomInt(10, -10);
        const x = randomInt(10, -10);
        const y = m * x + t;
        const findX = Math.random() < 0.5;
        
        return {
            type: 'missing_coord',
            text: `Ein Punkt P liegt auf der Geraden y = ${m}x + ${t}. Berechne die fehlende Koordinate.`,
            data: { point: findX ? `P(x|${y})` : `P(${x}|y)` },
            answer: findX ? { val: x } : { val: y },
            answerFormat: 'single_number',
            inputPrefix: findX ? 'x =' : 'y ='
        };
    }

    function createEquationFromPointSlopeQuestion() {
        const m = randomInt(3, -3) || 1;
        const t = randomInt(8, -8);
        const x = randomInt(10, -10);
        const y = m * x + t;
        return {
            type: 'equation_ps',
            text: `Bestimme die Geradengleichung (y=mx+t) mit der Steigung m=${m} durch den Punkt P(${x}|${y}).`,
            data: {},
            answer: { m: m, t: t },
            answerFormat: 'equation'
        };
    }

    function createEquationFromTwoPointsQuestion() {
        const m = randomChoice([1, -1, 2, -2, 0.5, -0.5, 3, -3]);
        const t = randomInt(8, -8);

        const x1 = randomInt(5, -5);
        const y1 = formatNumber(m * x1 + t);

        let x2;
        do { x2 = randomInt(5, -5); } while (x1 === x2);
        const y2 = formatNumber(m * x2 + t);

        return {
            type: 'equation_2p',
            text: `Bestimme die Geradengleichung (y=mx+t), die durch die Punkte P₁(${x1}|${y1}) und P₂(${x2}|${y2}) verläuft.`,
            data: {},
            answer: { m: m, t: t },
            answerFormat: 'equation'
        };
    }

    function createZeroQuestion() {
        const m = randomInt(5, -5) || 1;
        const x_zero = randomInt(10, -10);
        const t = -m * x_zero;
        return {
            type: 'zero',
            text: `Berechne die Nullstelle der Funktion y = ${m}x + ${t}.`,
            data: {},
            answer: { val: x_zero },
            answerFormat: 'single_number',
            inputPrefix: 'x ='
        };
    }

    function createIntersectionQuestion() {
        const isParallel = Math.random() < 0.15;
        const m1 = randomInt(5, -5) || 1;
        const t1 = randomInt(10, -10);
        let m2, t2, answer;

        if (isParallel) {
            m2 = m1;
            t2 = t1 + randomInt(5, 1) * (Math.random() < 0.5 ? 1 : -1);
            answer = 'none';
        } else {
            do { m2 = randomInt(5, -5) || -1; } while (m1 === m2);
            const x_intersect = randomInt(8, -8);
            t2 = (m1 - m2) * x_intersect + t1;
            const y_intersect = m1 * x_intersect + t1;
            answer = { x: formatNumber(x_intersect), y: formatNumber(y_intersect) };
        }
        
        return {
            type: 'intersection',
            text: 'Bestimme den Schnittpunkt der Geraden.',
            data: { g1: `g₁: y = ${m1}x + ${t1}`, g2: `g₂: y = ${m2}x + ${t2}` },
            answer: answer,
            answerFormat: 'point'
        };
    }
    
    function createGraphQuestion() {
        const m = randomChoice([1, -1, 2, -2, 0.5, -0.5]);
        const t = randomInt(4, -4);
        return {
            type: 'graph',
            text: 'Bestimme die Funktionsgleichung (y=mx+t) des abgebildeten Graphen.',
            data: { m, t },
            answer: { m, t },
            answerFormat: 'equation'
        };
    }


    // --- TEST FLOW ---
    function startTest() {
        document.getElementById('confirm-read').checked = false;
        document.getElementById('start-test-btn').disabled = true;

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';

        if (ggbApplet) {
            runTest();
        } else {
            var params = {
                "appName": "classic", "width": 800, "height": 600,
                "showToolBar": false, "showAlgebraInput": false, "showMenuBar": false,
                "perspective": "G", "useBrowserForJS": true, "enableShiftDragZoom": true, "showResetIcon": true,
                "xMin": -5, "xMax": 5, "yMin": -5, "yMax": 5,
                "appletOnLoad": function(api) {
                    ggbApplet = api;
                    runTest();
                }
            };
            var applet = new GGBApplet(params, true);
            applet.inject('ggb-element');
        }
    }
    
    function runTest() {
        questions = [];
        currentQuestionIndex = 0;
        const questionTypes = [
            createSlopeQuestion, createMissingCoordinateQuestion, createEquationFromPointSlopeQuestion,
            createZeroQuestion, createIntersectionQuestion, createGraphQuestion, createEquationFromTwoPointsQuestion
        ];
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            questions.push(randomChoice(questionTypes)());
        }
        displayQuestion();
    }

    function displayQuestion() {
        const q = questions[currentQuestionIndex];
        const ggbContainer = document.getElementById('ggb-container');
        
        document.getElementById('question-number').textContent = currentQuestionIndex + 1;
        document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100}%`;

        let taskHTML = q.text;
        
        if (q.type === 'graph') {
            ggbContainer.style.display = 'block';
            ggbApplet.reset();
            ggbApplet.evalCommand(`f(x) = ${q.data.m}*x + ${q.data.t}`);
            const p1_x = 0, p1_y = q.data.t;
            const p2_x = (q.data.m === 0.5 || q.data.m === -0.5) ? 2 : 1;
            const p2_y = q.data.m * p2_x + q.data.t;
            ggbApplet.evalCommand(`P1=(${p1_x}, ${p1_y})`);
            ggbApplet.evalCommand(`P2=(${p2_x}, ${p2_y})`);
        } else {
            ggbContainer.style.display = 'none';
            if (q.data.point) taskHTML += `<div class="task-data">${q.data.point}</div>`;
            if (q.data.g1) taskHTML += `<div class="task-data">${q.data.g1}</div><div class="task-data">${q.data.g2}</div>`;
        }
        document.getElementById('task-output').innerHTML = taskHTML;
        q.displayHTML = taskHTML; 
        
        document.querySelectorAll('.input-mask').forEach(m => m.style.display = 'none');
        if (q.answerFormat === 'single_number') {
            document.getElementById('input-mask-single').style.display = 'flex';
            document.getElementById('input-prefix').textContent = q.inputPrefix;
            document.getElementById('single-input').value = '';
        } else if (q.answerFormat === 'point') {
            document.getElementById('input-mask-point').style.display = 'block';
            document.getElementById('x-input').value = '';
            document.getElementById('y-input').value = '';
            document.getElementById('no-intersection-checkbox').checked = false;
        } else if (q.answerFormat === 'equation') {
            document.getElementById('input-mask-equation').style.display = 'flex';
            document.getElementById('m-input').value = '';
            document.getElementById('t-input').value = '';
        }
    }

    function saveAndNextQuestion() {
        const q = questions[currentQuestionIndex];
        let userAnswer = {};
        
        if (q.answerFormat === 'single_number') {
            userAnswer.val = document.getElementById('single-input').value.replace(',', '.');
        } else if (q.answerFormat === 'point') {
            userAnswer.x = document.getElementById('x-input').value.replace(',', '.');
            userAnswer.y = document.getElementById('y-input').value.replace(',', '.');
            userAnswer.isNone = document.getElementById('no-intersection-checkbox').checked;
        } else if (q.answerFormat === 'equation') {
            userAnswer.m = document.getElementById('m-input').value.replace(',', '.');
            userAnswer.t = document.getElementById('t-input').value.replace(',', '.');
        }
        q.userAnswer = userAnswer;

        currentQuestionIndex++;
        
        if (currentQuestionIndex < TOTAL_QUESTIONS) {
            displayQuestion();
        } else {
            evaluateTest();
        }
    }

    function formatAnswer(q, answerObj) {
        if (q.answerFormat === 'single_number') {
            return `${q.inputPrefix} ${answerObj.val}`;
        } else if (q.answerFormat === 'equation') {
            return `y = ${answerObj.m}x + ${answerObj.t}`;
        } else if (q.answerFormat === 'point') {
            if (answerObj.isNone || answerObj === 'none') {
                return "Kein Schnittpunkt";
            }
            return `S(${answerObj.x}|${answerObj.y})`;
        }
        return '';
    }

    function evaluateTest() {
        let score = 0;
        const resultDetails = document.getElementById('result-details');
        resultDetails.innerHTML = '';
        
        questions.forEach((q, index) => {
            let isCorrect = false;
            const ua = q.userAnswer;
            const ca = q.answer;
            
            if (q.answerFormat === 'single_number') {
                if(ua.val === "") ua.val = NaN; 
                isCorrect = Math.abs(parseFloat(ua.val) - ca.val) < 0.01;
            } else if (q.answerFormat === 'point') {
                if (ua.isNone) {
                    isCorrect = (ca === 'none');
                } else if (ca !== 'none') {
                    if(ua.x === "" || ua.y === "") {ua.x=NaN; ua.y=NaN;}
                    isCorrect = Math.abs(parseFloat(ua.x) - ca.x) < 0.01 && Math.abs(parseFloat(ua.y) - ca.y) < 0.01;
                }
            } else if (q.answerFormat === 'equation') {
                 if(ua.m === "" || ua.t === "") {ua.m=NaN; ua.t=NaN;}
                 isCorrect = Math.abs(parseFloat(ua.m) - ca.m) < 0.01 && Math.abs(parseFloat(ua.t) - ca.t) < 0.01;
            }
            if (isCorrect) score++;

            const item = document.createElement('div');
            item.className = 'result-item';
            const icon = isCorrect ? '<span class="correct-icon">✔</span>' : '<span class="wrong-icon">✖</span>';
            const userAnswerFormatted = formatAnswer(q, ua);
            const correctAnswerFormatted = formatAnswer(q, ca);
            
            item.innerHTML = `
                <p class="result-question"><strong>Frage ${index + 1}:</strong></p>
                <div>${q.displayHTML}</div>
                <p class="user-answer ${isCorrect ? 'correct' : 'incorrect'}">Deine Antwort: ${userAnswerFormatted} ${icon}</p>
                ${!isCorrect ? `<p class="correct-answer">Richtige Antwort: ${correctAnswerFormatted}</p>` : ''}
            `;
            resultDetails.appendChild(item);
        });

        const percentage = (score / TOTAL_QUESTIONS) * 100;
        let grade, feedback;

        if (percentage >= 92) { grade = "Note 1 (Sehr Gut)"; feedback = "Hervorragende Leistung! Du beherrschst die Themen der linearen Funktionen exzellent."; }
        else if (percentage >= 81) { grade = "Note 2 (Gut)"; feedback = "Sehr gut gemacht! Du hast ein solides Verständnis für lineare Funktionen."; }
        else if (percentage >= 67) { grade = "Note 3 (Befriedigend)"; feedback = "Gut gemacht! Du bist auf dem richtigen Weg, aber einige Themen könntest du noch einmal wiederholen."; }
        else if (percentage >= 50) { grade = "Note 4 (Ausreichend)"; feedback = "Bestanden! Es gibt jedoch noch einige Lücken. Wiederhole die Grundlagen der linearen Funktionen."; }
        else if (percentage >= 30) { grade = "Note 5 (Mangelhaft)"; feedback = "Das war leider noch nicht ausreichend. Schau dir die Lösungswege genau an und wiederhole die Themen intensiv."; }
        else { grade = "Note 6 (Ungenügend)"; feedback = "Leider nicht bestanden. Es ist wichtig, dass du dir die Grundlagen noch einmal von vorne ansiehst. Gib nicht auf!"; }
        
        document.getElementById('score-display').textContent = `${score} von ${TOTAL_QUESTIONS} Punkten`;
        document.getElementById('grade-display').textContent = grade;
        document.getElementById('feedback-display').textContent = feedback;
        
        document.getElementById('quiz-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
    }

</script>

</body>
</html>

