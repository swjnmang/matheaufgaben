<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitale Prüfung: Quadratische Funktionen</title>
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>
    <style>
        /* Modernes & ansprechendes Design */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #test-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            margin: 20px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        #test-container h2 {
            color: #333; margin-bottom: 15px; font-size: 1.4em;
        }
        /* Start & Result Screens */
        #start-screen, #result-screen {
            padding: 20px;
        }
        #start-screen p { line-height: 1.5; }
        #start-screen div { margin-top: 15px; }
        #result-screen h3 {
            font-size: 1.6em; margin-bottom: 10px;
        }
        .score { font-size: 2.2em; font-weight: bold; margin: 10px 0; }
        .grade { font-size: 1.3em; font-style: italic; color: #555; margin-bottom: 15px;}
        .feedback { line-height: 1.5; font-size: 0.9em; }
        #result-details {
            margin-top: 25px;
            text-align: left;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
            font-size: 0.9em;
        }
        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .result-item p { margin: 4px 0; }
        .result-question { font-weight: bold; }
        .user-answer.incorrect, .correct-answer { color: #dc3545; }
        .user-answer.correct { color: #28a745; }
        .correct-icon { color: #28a745; font-weight: bold; }
        .wrong-icon { color: #dc3545; font-weight: bold; }

        /* Quiz Screen */
        #quiz-screen {
            display: none;
        }
        #progress-bar-container {
            width: 100%; background-color: #e0e0e0; border-radius: 10px; margin-bottom: 15px;
        }
        #progress-bar {
            width: 0%; height: 8px; background-color: #0073aa; border-radius: 10px; transition: width 0.3s ease;
        }
        #ggb-container {
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1 / 1;
            margin: 0 auto 15px auto;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dcdcdc;
        }
        #task-output {
            background-color: #f8f9fa; border: 1px solid #dcdcdc; border-radius: 8px;
            padding: 20px; margin-bottom: 15px; min-height: auto;
            font-size: 1em; line-height: 1.5; color: #495057;
        }
        .task-data {
            font-size: 1.2em; font-weight: bold; color: #005a87;
            font-family: 'Courier New', Courier, monospace; display: block; margin-top: 8px;
        }
        .input-mask {
            margin: 15px 0; font-size: 1.1em; /* Smaller base font */
            font-family: 'Courier New', Courier, monospace;
            display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;
        }
        .equation-input {
            padding: 8px; border-radius: 6px; border: 1px solid #ccc;
            font-size: 1em; width: 70px; text-align: center; font-family: inherit;
        }
        /* MC Fragen Block */
        .mc-question-block {
             background-color: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px;
        }
        .mc-question-block p { 
            font-size: 0.9rem; /* Smaller font */
            margin: 0 0 8px 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .mc-answer-btn {
            flex: 1; min-width: 120px; padding: 8px; font-size: 0.8rem; cursor: pointer; /* Smaller */
            border: 1px solid #ccc; border-radius: 8px; background-color: white; transition: all 0.2s ease;
        }
         .mc-answer-btn.selected {
            background-color: #0073aa; color: white; border-color: #0073aa;
        }

        /* Buttons */
        .button-container {
            display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
        }
        .generator-button {
            background: linear-gradient(145deg, #0078b3, #005f8e); color: white;
            border: none; border-radius: 8px; padding: 10px 24px;
            font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
        }
        .generator-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .generator-button:disabled {
             background: linear-gradient(145deg, #c0c0c0, #a9a9a9);
             cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 480px) {
            #input-mask-general-form, #input-mask-vertex-form {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>

<div id="test-container">
    <div id="start-screen">
        <h2>Digitale Prüfung: Quadratische Funktionen</h2>
        <p>Dieser Test besteht aus 10 zufälligen Aufgaben zu allen wichtigen Themen der quadratischen Funktionen.</p>
        <p><b>Wichtiger Hinweis:</b> Halte bitte Stift und Papier bereit, um alle Berechnungen schriftlich festzuhalten.</p>
        <div>
            <input type="checkbox" id="confirm-read">
            <label for="confirm-read"> Ich habe die Information gelesen.</label>
        </div>
        <br>
        <button class="generator-button" id="start-test-btn" onclick="startTest()" disabled>Test starten</button>
    </div>

    <div id="quiz-screen">
        <h2>Aufgabe <span id="question-number">1</span></h2>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
        
        <div id="ggb-container" style="display: none;"><div id="ggb-element"></div></div>
        <div id="task-output"></div>
        
        <!-- Input Masks -->
        <div id="input-mask-vertex" class="input-mask" style="display: none;">
            S( <input type="text" id="xs-input" class="equation-input" placeholder="xₛ"> | <input type="text" id="ys-input" class="equation-input" placeholder="yₛ"> )
        </div>
        <div id="input-mask-nullstellen" class="input-mask" style="display: none;">
            x₁=<input type="text" id="n1-input" class="equation-input">, x₂=<input type="text" id="n2-input" class="equation-input">
            <div>
                 <input type="checkbox" id="no-nullstelle-checkbox"><label for="no-nullstelle-checkbox" style="font-size: 0.6em; font-family: sans-serif;"> Keine Nullstelle</label>
            </div>
        </div>
        <div id="input-mask-general-form" class="input-mask" style="display: none;">
            y = <input type="text" id="a-input" class="equation-input" placeholder="a">x² + <input type="text" id="b-input" class="equation-input" placeholder="b">x + <input type="text" id="c-input" class="equation-input" placeholder="c">
        </div>
        <div id="input-mask-vertex-form" class="input-mask" style="display: none;">
            y = <input type="text" id="vf-a-input" class="equation-input" placeholder="a">(x - <input type="text" id="vf-xs-input" class="equation-input" placeholder="xₛ">)² + <input type="text" id="vf-ys-input" class="equation-input" placeholder="yₛ">
        </div>
        <div id="input-mask-mc-properties" class="input-mask" style="display: none; flex-direction: column;">
             <div class="mc-question-block">
                <p>Der Graph ist im Vergleich zur Normalparabel (gestrichelt)...</p>
                <div class="button-container">
                    <button class="mc-answer-btn" data-question="stretch" data-answer="gestreckt">...gestreckt (schmaler).</button>
                    <button class="mc-answer-btn" data-question="stretch" data-answer="gestaucht">...gestaucht (breiter).</button>
                </div>
             </div>
             <div class="mc-question-block">
                <p>Der Graph ist...</p>
                <div class="button-container">
                    <button class="mc-answer-btn" data-question="opening" data-answer="oben">...nach oben geöffnet.</button>
                    <button class="mc-answer-btn" data-question="opening" data-answer="unten">...nach unten geöffnet.</button>
                </div>
             </div>
        </div>

        <button class="generator-button" id="next-btn" onclick="saveAndNextQuestion()">Nächste Frage</button>
    </div>

    <div id="result-screen" style="display: none;">
        <h3>Dein Ergebnis</h3>
        <div id="score-display" class="score"></div>
        <div id="grade-display" class="grade"></div>
        <div id="feedback-display" class="feedback"></div>
        <hr>
        <h3>Detailauswertung:</h3>
        <div id="result-details"></div>
        <br>
        <button class="generator-button" onclick="startTest()">Neuen Test starten</button>
    </div>

</div>

<script>
    const TOTAL_QUESTIONS = 10;
    let questions = [];
    let currentQuestionIndex = 0;
    let totalPossibleScore = 0;
    var ggbApplet;

    document.getElementById('confirm-read').addEventListener('change', function() {
        document.getElementById('start-test-btn').disabled = !this.checked;
    });

    const formatNumber = (num) => Math.round(num * 100) / 100;
    const randomInt = (max, min = 0) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const randomHalfInt = (max, min) => randomInt(max * 2, min * 2) / 2;

    // --- QUESTION GENERATION LOGIC ---
    function createReadVertexQuestion() {
        const a = randomChoice([1, -1, 2, -2, 0.5, -0.5]);
        const xs = randomInt(5, -5);
        const ys = randomInt(5, -5);
        const xs_str = (xs >= 0) ? `- ${xs}` : `+ ${Math.abs(xs)}`;
        const ys_str = (ys >= 0) ? `+ ${ys}` : `- ${Math.abs(ys)}`;
        const a_str = (a === 1) ? '' : (a === -1) ? '-' : a;
        const equation = `y = ${a_str}(x ${xs_str})² ${ys_str}`;
        return {
            text: `Lese den Scheitelpunkt der Parabel ab.`,
            data: { equation: equation },
            answer: { xs: xs, ys: ys },
            answerFormat: 'vertex',
            points: 1
        };
    }
    
    function createCalcVertexQuestion() {
        const a = randomChoice([1, -1, 2, -2, 0.5, -0.5]);
        const xs = randomInt(4, -4);
        const ys = randomInt(8, -8);
        const b = -2 * a * xs;
        const c = a * xs * xs + ys;
        const b_str = b >= 0 ? `+ ${b}`: `- ${Math.abs(b)}`;
        const c_str = c >= 0 ? `+ ${c}`: `- ${Math.abs(c)}`;
        const equation = `y = ${a}x² ${b_str}x ${c_str}`;
        return {
            text: `Berechne den Scheitelpunkt der Parabel.`,
            data: { equation: equation },
            answer: { xs: formatNumber(xs), ys: formatNumber(ys) },
            answerFormat: 'vertex',
            points: 2
        };
    }

    function createCalcNullstellenQuestion() {
        const a = randomChoice([1, -1, 2, -2]);
        const n1 = randomInt(4, -4);
        let n2;
        do { n2 = randomInt(4, -4); } while(n1 === n2);
        
        const b = -a * (n1 + n2);
        const c = a * n1 * n2;
        const b_str = b >= 0 ? `+ ${b}`: `- ${Math.abs(b)}`;
        const c_str = c >= 0 ? `+ ${c}`: `- ${Math.abs(c)}`;
        const equation = `y = ${a}x² ${b_str}x ${c_str}`;

        return {
            text: `Berechne die Nullstelle(n) der Parabel. Ordne sie von klein nach groß.`,
            data: { equation: equation },
            answer: { n1: Math.min(n1, n2), n2: Math.max(n1, n2) },
            answerFormat: 'nullstellen',
            points: 3
        };
    }
    
    function createConvertToGeneralFormQuestion() {
        const a = randomChoice([1, -1, 2, -2]);
        let xs;
        do { xs = randomInt(4, -4); } while (xs === 0); // Ensure xs is not zero
        const ys = randomInt(8, -8);
        const xs_str = xs > 0 ? `- ${xs}` : `+ ${Math.abs(xs)}`;
        const ys_str = ys > 0 ? `+ ${ys}` : `- ${Math.abs(ys)}`;
        const a_str = (a === 1) ? '' : (a === -1) ? '-' : a;
        const equation = `y = ${a_str}(x ${xs_str})² ${ys_str}`;

        const b = -2 * a * xs;
        const c = a * xs * xs + ys;
        return {
            text: `Forme die Scheitelform in die allgemeine Form (y=ax²+bx+c) um.`,
            data: { equation: equation },
            answer: { a: a, b: b, c: c },
            answerFormat: 'general_form',
            points: 2
        };
    }
    
    function createVertexFormFromPointsQuestion() {
        const a = randomChoice([1, -1, 2, -2, 0.5, -0.5]);
        const xs = randomInt(5, -5);
        const ys = randomInt(5, -5);

        let px;
        do { px = randomInt(5, -5); } while (px === xs);
        const py = a * (px - xs) * (px - xs) + ys;

        return {
            text: `Bestimme die Funktionsgleichung in Scheitelform (y=a(x-xₛ)²+yₛ), die den Scheitelpunkt S und den Punkt P enthält.`,
            data: { equation: `S(${xs}|${ys}) und P(${px}|${py})` },
            answer: { a: a, xs: xs, ys: ys },
            answerFormat: 'vertex_form',
            points: 2
        };
    }
    
    function createGeneralFormFrom2PointsAndAQuestion() {
        const a = randomChoice([1, -1, 2, -2, 0.5, -0.5]);
        const b = randomInt(5, -5);
        const c = randomInt(5, -5);

        let p1_x;
        do { p1_x = randomInt(3, -3); } while (p1_x === 0);
        const p1_y = formatNumber(a * p1_x * p1_x + b * p1_x + c);

        let p2_x;
        do { p2_x = randomInt(3, -3); } while (p2_x === 0 || p2_x === p1_x);
        const p2_y = formatNumber(a * p2_x * p2_x + b * p2_x + c);

        return {
            text: `Bestimme die Funktionsgleichung in allgemeiner Form (y=ax²+bx+c). Gegeben sind der Formfaktor <strong>a = ${a}</strong> und die Punkte P₁ und P₂.`,
            data: { equation: `P₁(${p1_x}|${p1_y}) und P₂(${p2_x}|${p2_y})`},
            answer: { a: a, b: b, c: c },
            answerFormat: 'general_form',
            points: 3
        };
    }
    
    function createGraphPropertiesQuestion() {
        const possibleA = [-5, -4, -3, -2, -1.5, -0.5, 0.5, 1.5, 2, 3, 4, 5];
        let a = randomChoice(possibleA);
        
        return {
            type: 'graph_properties',
            text: 'Beantworte die Fragen zu den Eigenschaften des abgebildeten Graphen der Form y=ax².<br><small>Hinweis: Wenn du den Funktionsgraph nicht siehst, musst das Koordinatensystem verschieben und/oder vergrößern.</small>',
            data: { a: a, b: 0, c: 0 },
            answer: { 
                stretch: Math.abs(a) > 1 ? 'gestreckt' : 'gestaucht',
                opening: a > 0 ? 'oben' : 'unten'
            },
            answerFormat: 'mc_properties',
            points: 1
        };
    }
    
    function createVertexFormFromGraphQuestion() {
        const a = randomChoice([-2, -1.5, -0.5, 0.5, 1.5, 2]);
        const xs = randomInt(4, -4);
        const ys = randomInt(4, -4);
        return {
            type: 'vertex_form_graph',
            text: `Bestimme die Funktionsgleichung in Scheitelform. Der Formfaktor ist <strong>a = ${a}</strong>.<br><small>Hinweis: Wenn du den Funktionsgraph nicht siehst, musst das Koordinatensystem verschieben und/oder vergrößern.</small>`,
            data: { a, xs, ys },
            answer: { a: a, xs: xs, ys: ys },
            answerFormat: 'vertex_form',
            points: 1
        };
    }

    // --- TEST FLOW ---
    function startTest() {
        document.getElementById('confirm-read').checked = false;
        document.getElementById('start-test-btn').disabled = true;

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';

        if (ggbApplet) {
            runTest();
        } else {
            var params = {
                "appName": "classic", "width": 800, "height": 600,
                "showToolBar": false, "showAlgebraInput": false, "showMenuBar": false,
                "perspective": "G", "useBrowserForJS": true, "enableShiftDragZoom": true, "showResetIcon": true,
                "appletOnLoad": function(api) {
                    ggbApplet = api;
                    runTest();
                }
            };
            var applet = new GGBApplet(params, true);
            applet.inject('ggb-element');
        }
    }
    
    function runTest() {
        questions = [];
        currentQuestionIndex = 0;
        totalPossibleScore = 0;
        
        const graphPropertiesQuestion = createGraphPropertiesQuestion;
        const otherQuestionTypes = [
            createReadVertexQuestion, createCalcVertexQuestion, createCalcNullstellenQuestion,
            createConvertToGeneralFormQuestion, createVertexFormFromPointsQuestion, createGeneralFormFrom2PointsAndAQuestion,
            createVertexFormFromGraphQuestion
        ];

        // Add 1 or 2 of the special question
        const countOfSpecialQuestion = randomInt(2, 1);
        for (let i = 0; i < countOfSpecialQuestion; i++) {
            const newQuestion = graphPropertiesQuestion();
            questions.push(newQuestion);
            totalPossibleScore += newQuestion.points;
        }

        // Fill the rest with other types
        const remainingQuestions = TOTAL_QUESTIONS - countOfSpecialQuestion;
        for (let i = 0; i < remainingQuestions; i++) {
            const newQuestion = randomChoice(otherQuestionTypes)();
            questions.push(newQuestion);
            totalPossibleScore += newQuestion.points;
        }

        // Shuffle the final list of questions
        questions.sort(() => Math.random() - 0.5);
        
        displayQuestion();
    }

    function displayQuestion() {
        const q = questions[currentQuestionIndex];
        const ggbContainer = document.getElementById('ggb-container');
        
        document.getElementById('question-number').textContent = currentQuestionIndex + 1;
        document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100}%`;

        let taskHTML = q.text;
        
        if (q.type === 'graph_properties' || q.type === 'vertex_form_graph') {
            ggbContainer.style.display = 'block';
            ggbApplet.reset();
            setTimeout(() => { ggbApplet.setCoordSystem(-5, 5, -5, 5); }, 100);
            
            let a = q.data.a, b = q.data.b || 0, c = q.data.c || 0, xs = q.data.xs, ys = q.data.ys;

            if(q.type === 'vertex_form_graph') {
                 ggbApplet.evalCommand(`f(x) = ${a}*(x - (${xs}))^2 + ${ys}`);
                 ggbApplet.evalCommand(`S=(${xs},${ys})`);
            } else {
                 ggbApplet.evalCommand(`f(x) = ${a}*x^2 + ${b}*x + ${c}`);
                 ggbApplet.evalCommand(`n(x) = x^2`);
                 ggbApplet.setLineStyle('n', 1);
                 ggbApplet.setColor('n', 150, 150, 150);
            }
        } else {
            ggbContainer.style.display = 'none';
            if (q.data.equation) taskHTML += `<div class="task-data">${q.data.equation}</div>`;
        }
        document.getElementById('task-output').innerHTML = taskHTML;
        q.displayHTML = taskHTML; 
        
        document.querySelectorAll('.input-mask').forEach(m => m.style.display = 'none');
        if (q.answerFormat === 'vertex') {
            document.getElementById('input-mask-vertex').style.display = 'flex';
            document.getElementById('xs-input').value = '';
            document.getElementById('ys-input').value = '';
        } else if (q.answerFormat === 'nullstellen') {
            document.getElementById('input-mask-nullstellen').style.display = 'block';
            document.getElementById('n1-input').value = '';
            document.getElementById('n2-input').value = '';
            document.getElementById('no-nullstelle-checkbox').checked = false;
        } else if (q.answerFormat === 'general_form') {
            document.getElementById('input-mask-general-form').style.display = 'flex';
            document.getElementById('a-input').value = '';
            document.getElementById('b-input').value = '';
            document.getElementById('c-input').value = '';
        } else if (q.answerFormat === 'vertex_form') {
            document.getElementById('input-mask-vertex-form').style.display = 'flex';
            document.getElementById('vf-a-input').value = '';
            document.getElementById('vf-xs-input').value = '';
            document.getElementById('vf-ys-input').value = '';
        } else if (q.answerFormat === 'mc_properties') {
            document.getElementById('input-mask-mc-properties').style.display = 'flex';
            document.querySelectorAll('.mc-answer-btn').forEach(btn => btn.classList.remove('selected'));
        }
    }

    function saveAndNextQuestion() {
        const q = questions[currentQuestionIndex];
        let userAnswer = {};
        
        if (q.answerFormat === 'vertex') {
            userAnswer.xs = document.getElementById('xs-input').value.replace(',', '.');
            userAnswer.ys = document.getElementById('ys-input').value.replace(',', '.');
        } else if (q.answerFormat === 'nullstellen') {
            userAnswer.n1 = document.getElementById('n1-input').value.replace(',', '.');
            userAnswer.n2 = document.getElementById('n2-input').value.replace(',', '.');
            userAnswer.isNone = document.getElementById('no-nullstelle-checkbox').checked;
        } else if (q.answerFormat === 'general_form') {
            userAnswer.a = document.getElementById('a-input').value.replace(',', '.');
            userAnswer.b = document.getElementById('b-input').value.replace(',', '.');
            userAnswer.c = document.getElementById('c-input').value.replace(',', '.');
        } else if (q.answerFormat === 'vertex_form') {
            userAnswer.a = document.getElementById('vf-a-input').value.replace(',', '.');
            userAnswer.xs = document.getElementById('vf-xs-input').value.replace(',', '.');
            userAnswer.ys = document.getElementById('vf-ys-input').value.replace(',', '.');
        } else if (q.answerFormat === 'mc_properties') {
            const stretchAnswer = document.querySelector('.mc-answer-btn[data-question="stretch"].selected');
            const openingAnswer = document.querySelector('.mc-answer-btn[data-question="opening"].selected');
            userAnswer.stretch = stretchAnswer ? stretchAnswer.dataset.answer : null;
            userAnswer.opening = openingAnswer ? openingAnswer.dataset.answer : null;
        }
        q.userAnswer = userAnswer;

        currentQuestionIndex++;
        
        if (currentQuestionIndex < TOTAL_QUESTIONS) {
            displayQuestion();
        } else {
            evaluateTest();
        }
    }

    function formatAnswer(q, answerObj) {
        if (!answerObj) return "Keine Antwort gegeben";
        if (q.answerFormat === 'vertex') {
            return `S(${answerObj.xs || "?"}|${answerObj.ys || "?"})`;
        } else if (q.answerFormat === 'nullstellen') {
            if (answerObj.isNone || answerObj === 'none') return "Keine Nullstelle";
            return `x₁=${answerObj.n1 || "?"}, x₂=${answerObj.n2 || "?"}`;
        } else if (q.answerFormat === 'general_form') {
            const b_val = parseFloat(answerObj.b) || 0;
            const c_val = parseFloat(answerObj.c) || 0;
            const b_sign = b_val >= 0 ? '+' : '-';
            const c_sign = c_val >= 0 ? '+' : '-';
            return `y = ${answerObj.a || "?"}x² ${b_sign} ${Math.abs(b_val)}x ${c_sign} ${Math.abs(c_val)}`;
        } else if (q.answerFormat === 'vertex_form') {
             const a_val = parseFloat(answerObj.a) || 0;
             const xs_val = parseFloat(answerObj.xs) || 0;
             const ys_val = parseFloat(answerObj.ys) || 0;
             const a_str = a_val === 1 ? '' : (a_val === -1 ? '-' : a_val);
             const xs_str = xs_val > 0 ? `- ${xs_val}`: `+ ${Math.abs(xs_val)}`;
             const ys_str = ys_val > 0 ? `+ ${ys_val}`: `- ${Math.abs(ys_val)}`;
             return `y = ${a_str || '?'}(x ${xs_str || '?'})² ${ys_str || '?'}`;
        } else if (q.answerFormat === 'mc_properties') {
            return `Form: ${answerObj.stretch || '?'}, Öffnung: ${answerObj.opening || '?'}`;
        }
        return '';
    }


    function evaluateTest() {
        let score = 0;
        const resultDetails = document.getElementById('result-details');
        resultDetails.innerHTML = '';
        
        questions.forEach((q, index) => {
            let isCorrect = false;
            const ua = q.userAnswer;
            const ca = q.answer;
            
            if (ua) {
                if (q.answerFormat === 'vertex') {
                    if(ua.xs === "" || ua.ys === "") {ua.xs=NaN; ua.ys=NaN;}
                    isCorrect = Math.abs(parseFloat(ua.xs) - ca.xs) < 0.01 && Math.abs(parseFloat(ua.ys) - ca.ys) < 0.01;
                } else if (q.answerFormat === 'nullstellen') {
                    if (ua.isNone) {
                        isCorrect = (ca === 'none');
                    } else {
                        if(ua.n1 === "" || ua.n2 === "") {ua.n1=NaN; ua.n2=NaN;}
                        isCorrect = (Math.abs(parseFloat(ua.n1) - ca.n1) < 0.01 && Math.abs(parseFloat(ua.n2) - ca.n2) < 0.01) || (Math.abs(parseFloat(ua.n1) - ca.n2) < 0.01 && Math.abs(parseFloat(ua.n2) - ca.n1) < 0.01);
                    }
                } else if (q.answerFormat === 'general_form') {
                     if(ua.a === "" || ua.b === "" || ua.c === "") {ua.a=NaN; ua.b=NaN; ua.c=NaN;}
                     isCorrect = Math.abs(parseFloat(ua.a) - ca.a) < 0.01 && Math.abs(parseFloat(ua.b) - ca.b) < 0.01 && Math.abs(parseFloat(ua.c) - ca.c) < 0.01;
                } else if (q.answerFormat === 'vertex_form') {
                     if(ua.a === "" || ua.xs === "" || ua.ys === "" ) {ua.a=NaN; ua.xs=NaN; ua.ys=NaN;}
                     isCorrect = Math.abs(parseFloat(ua.a) - ca.a) < 0.01 && Math.abs(parseFloat(ua.xs) - ca.xs) < 0.01 && Math.abs(parseFloat(ua.ys) - ca.ys) < 0.01;
                } else if (q.answerFormat === 'mc_properties') {
                    isCorrect = ua.stretch === ca.stretch && ua.opening === ca.opening;
                }
            }
            if (isCorrect) score += q.points;

            const item = document.createElement('div');
            item.className = 'result-item';
            const icon = isCorrect ? '<span class="correct-icon">✔</span>' : '<span class="wrong-icon">✖</span>';
            const userAnswerFormatted = formatAnswer(q, ua);
            const correctAnswerFormatted = formatAnswer(q, ca);
            
            item.innerHTML = `
                <p class="result-question"><strong>Frage ${index + 1} (${q.points} P.):</strong></p>
                <div>${q.displayHTML}</div>
                <p class="user-answer ${isCorrect ? 'correct' : 'incorrect'}">Deine Antwort: ${userAnswerFormatted} ${icon}</p>
                ${!isCorrect ? `<p class="correct-answer">Richtige Antwort: ${correctAnswerFormatted}</p>` : ''}
            `;
            resultDetails.appendChild(item);
        });

        const percentage = (score / totalPossibleScore) * 100;
        let grade, feedback;

        if (percentage >= 92) { grade = "Note 1 (Sehr Gut)"; feedback = "Hervorragende Leistung! Du beherrschst die Themen der quadratischen Funktionen exzellent."; }
        else if (percentage >= 81) { grade = "Note 2 (Gut)"; feedback = "Sehr gut gemacht! Du hast ein solides Verständnis für quadratische Funktionen."; }
        else if (percentage >= 67) { grade = "Note 3 (Befriedigend)"; feedback = "Gut gemacht! Du bist auf dem richtigen Weg, aber einige Themen könntest du noch einmal wiederholen."; }
        else if (percentage >= 50) { grade = "Note 4 (Ausreichend)"; feedback = "Bestanden! Es gibt jedoch noch einige Lücken. Wiederhole die Grundlagen der quadratischen Funktionen."; }
        else if (percentage >= 30) { grade = "Note 5 (Mangelhaft)"; feedback = "Das war leider noch nicht ausreichend. Schau dir die Lösungswege genau an und wiederhole die Themen intensiv."; }
        else { grade = "Note 6 (Ungenügend)"; feedback = "Leider nicht bestanden. Es ist wichtig, dass du dir die Grundlagen noch einmal von vorne ansiehst. Gib nicht auf!"; }
        
        document.getElementById('score-display').textContent = `${score} von ${totalPossibleScore} Punkten`;
        document.getElementById('grade-display').textContent = grade;
        document.getElementById('feedback-display').textContent = feedback;
        
        document.getElementById('quiz-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
    }
    
    // Setup for MC buttons
    document.querySelectorAll('.mc-answer-btn').forEach(button => {
        button.addEventListener('click', () => {
            const question = button.dataset.question;
            document.querySelectorAll(`.mc-answer-btn[data-question="${question}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
        });
    });

</script>
</body>
</html>

